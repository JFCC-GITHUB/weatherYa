<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WeatherYa V5</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        body {
            background-color: #FFFFFF;
            color: #1C1C1E;
            font-family: "Inter", "Noto Sans TC", "Noto Sans JP", sans-serif;
            margin: 0;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #mini-map {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            flex-shrink: 0;
            border: 2px solid #F2F2F7;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .stat-card {
            background: #F9F9FB;
            border-radius: 24px;
            padding: 16px;
            border: 1px solid #F2F2F7;
        }

        .btn-loc {
            padding: 10px 18px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 800;
            background: #F2F2F7;
            color: #8E8E93;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }

        .btn-loc.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
        }

        .chart-wrapper {
            width: 100%;
            height: 280px;
            position: relative;
        }

        .forecast-list-item {
            display: grid;
            grid-template-columns: 55px 40px 1fr 90px;
            align-items: center;
            padding: 18px 16px;
            background: #F9F9FB;
            border-radius: 22px;
            gap: 8px;
        }

        .change-up { color: #FF3B30; }
        .change-down { color: #007AFF; }
        
        .loader-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .bottom-action-btn {
            position: fixed; bottom: 40px; right: 20px;
            width: 60px; height: 60px; border-radius: 30px;
            background: #007AFF; color: white; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
            z-index: 1000;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute; top: -5px; right: -5px;
            background: #FF3B30; color: white;
            width: 18px; height: 18px; border-radius: 9px;
            font-size: 10px; display: none; align-items: center; justify-content: center;
            z-index: 20;
        }

        .btn-loc:hover .delete-btn { display: flex; }
    </style>
</head>
<body>

    <div id="loader" class="loader-screen">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-[11px] font-black text-slate-400 tracking-widest uppercase">WeatherYa Syncing</p>
    </div>

    <!-- æœå°‹è¦–çª— -->
    <div id="search-modal" class="fixed inset-0 z-[5000] hidden bg-white p-6 pt-16">
        <div class="max-w-md mx-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 id="ui-search-title" class="text-3xl font-black tracking-tight">æœå°‹åœ°é»</h2>
                <button onclick="toggleSearch(false)" class="text-slate-400 font-bold" id="ui-cancel">å–æ¶ˆ</button>
            </div>
            <div class="flex gap-3 mb-8">
                <input type="text" id="search-input" class="flex-grow bg-slate-100 rounded-2xl px-5 py-4 outline-none font-bold text-lg" placeholder="è¼¸å…¥åŸå¸‚..." onkeypress="if(event.key === 'Enter') performSearch()">
                <button onclick="performSearch()" class="bg-blue-600 text-white px-8 rounded-2xl font-black">å°‹æ‰¾</button>
            </div>
            <div id="search-results" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <main class="max-w-md mx-auto px-5 py-8 space-y-10">
        <header class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-blue-600">WeatherYa</h1>
                <p id="ui-date" class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">---</p>
            </div>
            <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                <button onclick="setLang('zh')" id="btn-zh" class="px-4 py-2 rounded-xl text-[10px] font-black transition-all">ç¹ä¸­</button>
                <button onclick="setLang('ja')" id="btn-ja" class="px-4 py-2 rounded-xl text-[10px] font-black transition-all">æ—¥æœ¬èª</button>
                <button onclick="setLang('en')" id="btn-en" class="px-4 py-2 rounded-xl text-[10px] font-black transition-all">EN</button>
            </div>
        </header>

        <!-- åœ°é»é¸æ“‡åˆ— -->
        <nav id="location-bar" class="flex gap-2 overflow-x-auto no-scrollbar py-2"></nav>

        <section class="flex justify-between items-center gap-4">
            <div class="flex-grow min-w-0">
                <div class="flex items-center gap-2 mb-2">
                    <span id="actual-model-badge" class="text-[9px] font-black bg-slate-900 text-white px-2 py-0.5 rounded-md uppercase">---</span>
                    <select id="model-select" onchange="manualModelChange(this.value)" class="bg-slate-100 text-[9px] font-black px-2 py-0.5 rounded-md uppercase outline-none border-none">
                        <option value="auto">Auto (Geo)</option>
                        <option value="jma_seamless">JMA</option>
                        <option value="kma_gdps">KMA</option>
                        <option value="ecmwf_ifs025">ECMWF</option>
                        <option value="gfs_global">GFS</option>
                    </select>
                </div>
                <h2 id="city-name" class="text-3xl font-black text-slate-900 truncate tracking-tight mb-2">---</h2>
                <div class="flex items-baseline gap-1">
                    <span id="curr-temp" class="text-7xl font-black tracking-tighter">--</span>
                    <span class="text-2xl font-black text-blue-600">Â°C</span>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-4 text-[10px] font-black text-slate-400 uppercase">
                    <div><span id="ui-lbl-feels">é«”æ„Ÿ</span> <span id="curr-feels" class="text-slate-900">--</span>Â°C</div>
                    <div><span id="ui-lbl-rain">é™é›¨</span> <span id="curr-rain" class="text-blue-600">--</span> mm</div>
                    <div class="col-span-2"><span id="ui-lbl-wind">é¢¨é€Ÿ</span> <span id="curr-wind" class="text-slate-900">--</span> km/h</div>
                </div>
            </div>
            <div id="mini-map"></div>
        </section>

        <section class="grid grid-cols-2 gap-3">
            <div class="stat-card">
                <div class="flex justify-between mb-3">
                    <span id="ui-lbl-yesterday" class="text-[10px] font-black text-slate-400 uppercase">æ˜¨æ—¥å›é¡§</span>
                    <span id="yest-emoji" class="text-lg">â˜€ï¸</span>
                </div>
                <div class="text-2xl font-black mb-1" id="yest-temp">-- / --</div>
                <div class="text-[9px] font-bold text-slate-400 mb-2 tracking-wide"><span id="ui-lbl-feels-yest">é«”æ„Ÿ</span> <span id="yest-feels" class="text-slate-900">--</span></div>
                <div class="pt-3 border-t border-slate-200 text-[9px] font-black space-y-1">
                    <div class="flex justify-between">
                        <span class="text-blue-600"><span id="yest-rain">--</span>mm</span>
                        <span><span id="yest-wind">--</span>km/h</span>
                    </div>
                    <div id="yest-diff-txt" class="text-slate-400 truncate opacity-70 italic">---</div>
                </div>
            </div>
            <div class="stat-card bg-blue-600 text-white border-none shadow-lg shadow-blue-50">
                <div class="flex justify-between mb-3">
                    <span id="ui-lbl-today" class="text-[10px] font-black text-blue-100 uppercase">ä»Šæ—¥é å ±</span>
                    <span id="today-emoji" class="text-lg">ğŸŒ¤ï¸</span>
                </div>
                <div class="text-2xl font-black mb-1" id="today-temp">-- / --</div>
                <div id="today-diff-txt" class="text-[9px] font-black text-blue-100 mb-2 tracking-wide">---</div>
                <div class="pt-3 border-t border-white/20 text-[9px] font-black space-y-1">
                    <div class="flex justify-between">
                        <span class="text-blue-100"><span id="today-rain">--</span>mm</span>
                        <span class="opacity-70"><span id="today-wind">--</span>km/h</span>
                    </div>
                    <div id="today-feels-txt" class="truncate">---</div>
                </div>
            </div>
        </section>

        <!-- 12H åœ–è¡¨ -->
        <section class="space-y-4">
            <h3 id="ui-lbl-12h" class="text-xs font-black text-slate-400 uppercase tracking-widest">12å°æ™‚æ™‚æ®µé å ±</h3>
            <div class="chart-wrapper">
                <div id="h12-icons" class="absolute top-0 w-full flex justify-around px-4 pointer-events-none z-10"></div>
                <canvas id="chart-h12"></canvas>
            </div>
        </section>

        <!-- 8D åœ–è¡¨ -->
        <section class="space-y-4">
            <h3 id="ui-lbl-8d" class="text-xs font-black text-slate-400 uppercase tracking-widest">8æ—¥æ°£æº«è¶¨å‹¢</h3>
            <div class="chart-wrapper">
                <div id="d8-icons" class="absolute top-0 w-full flex justify-around px-4 pointer-events-none z-10"></div>
                <canvas id="chart-d8"></canvas>
            </div>
        </section>

        <!-- 14D åˆ—è¡¨ -->
        <section class="space-y-4 pb-20">
            <h3 id="ui-lbl-14d" class="text-xs font-black text-slate-400 uppercase tracking-widest">14æ—¥æ·±åº¦é å ±</h3>
            <div id="list-14d" class="space-y-3"></div>
        </section>
    </main>

    <button onclick="toggleSearch(true)" class="bottom-action-btn">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    </button>

    <script>
        const I18N = {
            zh: {
                search_title: "æœå°‹åœ°é»", cancel: "å–æ¶ˆ", yesterday: "æ˜¨æ—¥å›é¡§", today: "ä»Šæ—¥é å ±",
                h12: "12å°æ™‚æ™‚æ®µé å ±", d8: "8æ—¥æ°£æº«è¶¨å‹¢", d14: "14æ—¥æ·±åº¦é å ±", current_loc: "ç›®å‰ä½ç½®",
                wind: "é¢¨é€Ÿ", rain: "é™é›¨", add: "æ–°å¢", diff_up: "é«˜æ–¼æ˜¨", diff_down: "ä½æ–¼æ˜¨", diff_same: "æŒå¹³",
                feels: "é«”æ„Ÿæº«åº¦", feels_short: "é«”æ„Ÿ", diff: "è®Šå‹•", temp_diff: "æº«", wind_diff: "é¢¨",
                cities: { gps: "ç›®å‰ä½ç½®", zhubei: "ç«¹åŒ—", taichung: "å°ä¸­", taipei: "å°åŒ—", osaka: "å¤§é˜ª" }
            },
            en: {
                search_title: "Search", cancel: "Cancel", yesterday: "Yesterday", today: "Today",
                h12: "12-H Forecast", d8: "8-Day Trend", d14: "14-Day Deep View", current_loc: "GPS",
                wind: "Wind", rain: "Rain", add: "Add", diff_up: "Higher", diff_down: "Lower", diff_same: "Same",
                feels: "Feels Like", feels_short: "Feels", diff: "Diff", temp_diff: "Temp", wind_diff: "Wind",
                cities: { gps: "GPS", zhubei: "Zhubei", taichung: "Taichung", taipei: "Taipei", osaka: "Osaka" }
            },
            ja: {
                search_title: "å ´æ‰€æ¤œç´¢", cancel: "æˆ»ã‚‹", yesterday: "æ˜¨æ—¥å›é¡§", today: "ä»Šæ—¥äºˆå ±",
                h12: "12æ™‚é–“äºˆå ±", d8: "8æ—¥é–“è¶¨å‹¢", d14: "14æ—¥é–“è©³ç´°äºˆå ±", current_loc: "ç¾åœ¨åœ°",
                wind: "é¢¨é€Ÿ", rain: "é™æ°´", add: "è¿½åŠ ", diff_up: "æ˜¨æ—¥ã‚ˆã‚Šé«˜ã„", diff_down: "æ˜¨æ—¥ã‚ˆã‚Šä½ã„", diff_same: "å¤‰ã‚ã‚‰ãš",
                feels: "ä½“æ„Ÿæº«åº¦", feels_short: "ä½“æ„Ÿ", diff: "å¤‰åŒ–", temp_diff: "æ°—æ¸©", wind_diff: "é¢¨",
                cities: { gps: "ç¾åœ¨åœ°", zhubei: "ç«¹åŒ—", taichung: "å°ä¸­", taipei: "å°åŒ—", osaka: "å¤§é˜ª" }
            }
        };

        const DEFAULT_LOCATIONS = [
            { id: 'gps', name: 'gps', lat: null, lon: null },
            { id: 'zhubei', name: 'zhubei', lat: 24.8388, lon: 121.0043, static: true },
            { id: 'taichung', name: 'taichung', lat: 24.1477, lon: 120.6736, static: true },
            { id: 'taipei', name: 'taipei', lat: 25.0330, lon: 121.5654, static: true },
            { id: 'osaka', name: 'osaka', lat: 34.6937, lon: 135.5023, static: true }
        ];

        const STATE = {
            lang: localStorage.getItem('wy_v5_lang') || 'zh',
            activeId: localStorage.getItem('wy_v5_active') || 'gps',
            model: localStorage.getItem('wy_v5_model') || 'auto',
            coords: { lat: 24.83, lon: 121.01 },
            locations: JSON.parse(localStorage.getItem('wy_v5_locs')) || DEFAULT_LOCATIONS,
            charts: {},
            map: null,
            marker: null
        };

        Chart.register(ChartDataLabels);

        function t(key, category = null) {
            const langData = I18N[STATE.lang];
            if (category && langData[category] && langData[category][key]) {
                return langData[category][key];
            }
            return langData[key] || key;
        }

        function getEmoji(code) {
            if (code === undefined) return 'â˜ï¸';
            if (code <= 1) return 'â˜€ï¸';
            if (code <= 3) return 'ğŸŒ¤ï¸';
            if (code <= 48) return 'ğŸŒ«ï¸';
            if (code <= 67) return 'ğŸŒ§ï¸';
            if (code <= 77) return 'â„ï¸';
            if (code <= 99) return 'â›ˆï¸';
            return 'â˜ï¸';
        }

        function determineModel(lat, lon) {
            if (STATE.model !== 'auto') return STATE.model;
            if (lat >= 21.8 && lat <= 25.8 && lon >= 119.0 && lon <= 122.8) return 'jma_seamless';
            if (lat >= 24 && lat <= 46 && lon >= 122 && lon <= 150) return 'jma_seamless';
            if (lat >= 33 && lat <= 39 && lon >= 124 && lon <= 131) return 'kma_gdps';
            return 'ecmwf_ifs025';
        }

        async function fetchRetry(url, limit = 5) {
            let delay = 1000;
            for (let i = 0; i < limit; i++) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Retry');
                    return await res.json();
                } catch (e) {
                    if (i === limit - 1) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        function getDataField(obj, baseName, model) {
            return obj[baseName] || obj[`${baseName}_${model}`];
        }

        async function refresh() {
            const { lat, lon } = STATE.coords;
            const model = determineModel(lat, lon);
            document.getElementById('actual-model-badge').innerText = model.split('_')[0].toUpperCase();

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,windspeed_10m_max&timezone=auto&past_days=2&forecast_days=14&models=${model}`;

            try {
                const raw = await fetchRetry(url);
                const h = getDataField(raw, 'hourly', model) || {};
                const d = getDataField(raw, 'daily', model) || {};
                const nowIdx = 48 + new Date().getHours(); 

                document.getElementById('curr-temp').innerText = Math.round(h.temperature_2m?.[nowIdx] ?? 0);
                document.getElementById('curr-feels').innerText = Math.round(h.apparent_temperature?.[nowIdx] ?? 0);
                document.getElementById('curr-wind').innerText = Math.round(h.windspeed_10m?.[nowIdx] ?? 0);
                document.getElementById('curr-rain').innerText = (h.precipitation?.[nowIdx] ?? 0).toFixed(1);

                // æ˜¨æ—¥
                document.getElementById('yest-emoji').innerText = getEmoji(d.weathercode?.[1]);
                document.getElementById('yest-temp').innerText = `${Math.round(d.temperature_2m_max?.[1] ?? 0)} / ${Math.round(d.temperature_2m_min?.[1] ?? 0)}`;
                document.getElementById('yest-feels').innerText = `${Math.round(d.apparent_temperature_max?.[1] ?? 0)}Â°`;
                document.getElementById('yest-rain').innerText = (d.precipitation_sum?.[1] ?? 0).toFixed(1);
                document.getElementById('yest-wind').innerText = Math.round(d.windspeed_10m_max?.[1] ?? 0);
                
                const yMaxDiff = (d.temperature_2m_max[1] - d.temperature_2m_max[0]).toFixed(1);
                const yWindDiff = (d.windspeed_10m_max[1] - d.windspeed_10m_max[0]).toFixed(1);
                document.getElementById('yest-diff-txt').innerText = `${t('temp_diff')}:${yMaxDiff>0?'+':''}${yMaxDiff}Â° ${t('wind_diff')}:${yWindDiff>0?'+':''}${yWindDiff}`;

                // ä»Šæ—¥
                const tMax = d.temperature_2m_max?.[2] ?? 0;
                const yMax = d.temperature_2m_max?.[1] ?? 0;
                const tDiff = (tMax - yMax).toFixed(1);
                const tWindDiff = (d.windspeed_10m_max[2] - d.windspeed_10m_max[1]).toFixed(1);

                document.getElementById('today-emoji').innerText = getEmoji(d.weathercode[2]);
                document.getElementById('today-temp').innerText = `${Math.round(tMax)} / ${Math.round(d.temperature_2m_min[2])}`;
                document.getElementById('today-rain').innerText = (d.precipitation_sum[2] ?? 0).toFixed(1);
                document.getElementById('today-wind').innerText = Math.round(d.windspeed_10m_max[2] ?? 0);
                document.getElementById('today-feels-txt').innerText = `${t('feels_short')} ${Math.round(d.apparent_temperature_max[2])}Â° / ${Math.round(d.apparent_temperature_min[2])}Â°`;
                
                let diffHtml = tDiff > 0 ? `â†‘${tDiff}Â° ${t('diff_up')}` : (tDiff < 0 ? `â†“${Math.abs(tDiff)}Â° ${t('diff_down')}` : t('diff_same'));
                diffHtml += ` | ${t('wind_diff')}:${tWindDiff>0?'+':''}${tWindDiff}`;
                document.getElementById('today-diff-txt').innerHTML = diffHtml;

                updateMap(lat, lon);
                renderH12Chart(h, nowIdx);
                renderD8Chart(d);
                render14DayList(d);
                reverseGeocode(lat, lon);

            } catch (err) { console.error(err); } 
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function renderH12Chart(h, start) {
            const labels = [], temps = [], feels = [], rainValues = [];
            const icons = document.getElementById('h12-icons');
            icons.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                const idx = start + i;
                if(!h.time?.[idx]) break;
                const time = new Date(h.time[idx]);
                labels.push(time.getHours() + ":00");
                temps.push(h.temperature_2m[idx]);
                feels.push(h.apparent_temperature[idx]);
                rainValues.push(h.precipitation?.[idx] || 0);
                const span = document.createElement('span');
                span.className = "text-[16px] pt-1";
                span.innerText = getEmoji(h.weathercode[idx]);
                icons.appendChild(span);
            }

            const maxRain = Math.max(...rainValues);
            const rainAxisMax = maxRain > 0 ? maxRain * 2.5 : 5;

            if(STATE.charts.h) STATE.charts.h.destroy();
            STATE.charts.h = new Chart(document.getElementById('chart-h12'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { 
                            type: 'bar', label: 'Rain', data: rainValues, 
                            backgroundColor: 'rgba(0, 122, 255, 0.4)', borderColor: '#007AFF', borderWidth: 1, 
                            yAxisID: 'yRain', borderRadius: 4, order: 2, barPercentage: 0.6
                        },
                        { type: 'line', label: 'Temp', data: temps, borderColor: '#FF3B30', borderWidth: 3, tension: 0.4, yAxisID: 'y', pointRadius: 0, order: 1 },
                        { type: 'line', label: 'Feels', data: feels, borderColor: '#FF9500', borderWidth: 2, borderDash: [4, 4], tension: 0.4, yAxisID: 'y', pointRadius: 0, order: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 40, bottom: 5 } },
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            display: (ctx) => (ctx.dataset.type === 'bar' ? ctx.dataset.data[ctx.dataIndex] > 0 : true),
                            font: { size: 9, weight: '900' }, 
                            formatter: (v, ctx) => (ctx.dataset.type === 'bar' ? v.toFixed(1) : Math.round(v) + 'Â°'),
                            color: (ctx) => (ctx.dataset.type === 'bar' ? '#007AFF' : '#1C1C1E'),
                            align: 'top', offset: 2
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '80%' }, 
                        yRain: { display: false, position: 'right', min: 0, max: rainAxisMax }, 
                        x: { grid: { display: false }, ticks: { font: { weight: '800', size: 10 }, color: '#8E8E93' }}
                    }
                }
            });
        }

        function renderD8Chart(d) {
            const labels = [], maxs = [], mins = [], rainActuals = [];
            const icons = document.getElementById('d8-icons');
            icons.innerHTML = '';
            for (let i = 2; i < 10; i++) {
                if(!d.time?.[i]) break;
                const date = new Date(d.time[i]);
                labels.push((date.getMonth() + 1) + "/" + date.getDate());
                maxs.push(d.temperature_2m_max[i]);
                mins.push(d.temperature_2m_min[i]);
                rainActuals.push(d.precipitation_sum?.[i] || 0);
                const span = document.createElement('span');
                span.className = "text-[16px] pt-1";
                span.innerText = getEmoji(d.weathercode[i]);
                icons.appendChild(span);
            }
            const maxRain = Math.max(...rainActuals);
            const rainAxisMax = maxRain > 0 ? maxRain * 3 : 10;
            if(STATE.charts.d) STATE.charts.d.destroy();
            STATE.charts.d = new Chart(document.getElementById('chart-d8'), {
                data: {
                    labels,
                    datasets: [
                        { type: 'bar', label: 'Rain', data: rainActuals, backgroundColor: 'rgba(0, 122, 255, 0.3)', borderColor: '#007AFF', borderWidth: 1, yAxisID: 'yRain', borderRadius: 4, order: 2, barPercentage: 0.5 },
                        { type: 'line', label: 'Max', data: maxs, borderColor: '#FF3B30', borderWidth: 3, tension: 0.4, pointRadius: 4, pointBackgroundColor: 'white', order: 1 },
                        { type: 'line', label: 'Min', data: mins, borderColor: '#007AFF', borderWidth: 3, tension: 0.4, pointRadius: 4, pointBackgroundColor: 'white', order: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 40, bottom: 5 } },
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            font: { size: 9, weight: '900' },
                            formatter: (v, ctx) => (ctx.dataset.type === 'bar' ? (v > 0 ? v.toFixed(1) : '') : Math.round(v) + 'Â°'),
                            color: (ctx) => (ctx.dataset.type === 'bar' ? '#007AFF' : '#1C1C1E'),
                            align: (ctx) => (ctx.dataset.type === 'bar' ? 'top' : (ctx.dataset.label === 'Max' ? 'top' : 'bottom'))
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '100%' }, 
                        yRain: { display: false, min: 0, max: rainAxisMax }, 
                        x: { grid: { display: false }, ticks: { font: { weight: '800', size: 10 }, color: '#8E8E93' }}
                    }
                }
            });
        }

        function render14DayList(d) {
            const container = document.getElementById('list-14d');
            container.innerHTML = '';
            for (let i = 2; i < 16; i++) {
                if(!d.time?.[i]) break;
                const date = new Date(d.time[i]);
                const langCode = STATE.lang === 'zh' ? 'zh-TW' : (STATE.lang === 'ja' ? 'ja-JP' : 'en-US');
                const dayStr = date.toLocaleDateString(langCode, { month: 'numeric', day: 'numeric' });
                const weekStr = date.toLocaleDateString(langCode, { weekday: 'short' });
                const diff = (d.temperature_2m_max[i] - d.temperature_2m_max[i-1]).toFixed(1);
                const item = document.createElement('div');
                item.className = "forecast-list-item active:scale-98 transition";
                item.innerHTML = `
                    <div class="leading-tight">
                        <div class="text-[9px] font-black text-slate-400 mb-0.5">${dayStr}</div>
                        <div class="text-xs font-black text-slate-800">${weekStr}</div>
                    </div>
                    <div class="text-2xl">${getEmoji(d.weathercode[i])}</div>
                    <div class="flex-grow min-w-0">
                        <div class="text-base font-black truncate">${Math.round(d.temperature_2m_max[i])}Â° / ${Math.round(d.temperature_2m_min[i])}Â°</div>
                        <div class="text-[8px] font-black text-slate-400 uppercase truncate">${t('feels_short')} ${Math.round(d.apparent_temperature_max[i])}Â°C</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] font-black text-blue-600">${(d.precipitation_sum?.[i]??0).toFixed(1)} mm</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${Math.round(d.windspeed_10m_max?.[i]??0)} km/h</div>
                        <div class="text-[8px] font-black mt-1">${diff > 0 ? `<span class="change-up">â†‘${diff}Â° ${t('diff')}</span>` : (diff < 0 ? `<span class="change-down">â†“${Math.abs(diff)}Â° ${t('diff')}</span>` : t('diff_same'))}</div>
                    </div>`;
                container.appendChild(item);
            }
        }

        function updateMap(lat, lon) {
            if (!STATE.map) {
                STATE.map = L.map('mini-map', { zoomControl: false, attributionControl: false, touchZoom: false, scrollWheelZoom: false, dragging: false }).setView([lat, lon], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(STATE.map);
                STATE.marker = L.marker([lat, lon]).addTo(STATE.map);
            } else {
                STATE.map.setView([lat, lon], 9);
                STATE.marker.setLatLng([lat, lon]);
            }
        }

        async function reverseGeocode(lat, lon) {
            const loc = STATE.locations.find(l => l.id === STATE.activeId);
            if(loc && loc.id !== 'gps') {
                document.getElementById('city-name').innerText = t(loc.name, 'cities');
                return;
            }
            try {
                const lang = STATE.lang === 'zh' ? 'zh-TW' : STATE.lang;
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&accept-language=${lang}`);
                const data = await res.json();
                document.getElementById('city-name').innerText = data.address.city || data.address.town || data.address.village || data.address.state || "Location";
            } catch (e) { document.getElementById('city-name').innerText = "Syncing..."; }
        }

        function renderLocationBar() {
            const bar = document.getElementById('location-bar');
            bar.innerHTML = '';
            STATE.locations.forEach(loc => {
                const btn = document.createElement('button');
                btn.className = `btn-loc ${STATE.activeId === loc.id ? 'active' : ''}`;
                btn.innerText = t(loc.name, 'cities');
                btn.onclick = (e) => {
                    if (e.target.tagName !== 'SPAN') switchLocation(loc.id);
                };

                if (!loc.static && loc.id !== 'gps') {
                    const del = document.createElement('span');
                    del.className = "delete-btn";
                    del.innerHTML = "Ã—";
                    del.onclick = (e) => {
                        e.stopPropagation();
                        removeLocation(loc.id);
                    };
                    btn.appendChild(del);
                }
                bar.appendChild(btn);
            });
        }

        function removeLocation(id) {
            STATE.locations = STATE.locations.filter(l => l.id !== id);
            localStorage.setItem('wy_v5_locs', JSON.stringify(STATE.locations));
            if (STATE.activeId === id) switchLocation('gps');
            else renderLocationBar();
        }

        function switchLocation(id) {
            STATE.activeId = id;
            localStorage.setItem('wy_v5_active', id);
            document.getElementById('loader').style.display = 'flex';
            const loc = STATE.locations.find(l => l.id === id);
            if(id === 'gps') {
                navigator.geolocation.getCurrentPosition(p => {
                    STATE.coords = { lat: p.coords.latitude, lon: p.coords.longitude };
                    refresh();
                }, () => { STATE.coords = { lat: 24.83, lon: 121.01 }; refresh(); }, { timeout: 6000 });
            } else { 
                STATE.coords = { lat: loc.lat, lon: loc.lon }; 
                refresh(); 
            }
            renderLocationBar();
        }

        function toggleSearch(s) { 
            document.getElementById('search-modal').classList.toggle('hidden', !s); 
            if(s) document.getElementById('search-input').focus();
        }

        async function performSearch() {
            const q = document.getElementById('search-input').value.trim();
            if(!q) return;
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '<div class="text-center py-20 font-black text-slate-300 text-xs animate-pulse">SEARCHING...</div>';
            try {
                const lang = STATE.lang === 'zh' ? 'zh-TW' : STATE.lang;
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=${lang}`);
                const data = await res.json();
                resBox.innerHTML = '';
                if(!data.results) { resBox.innerHTML = '<div class="text-center py-20 text-slate-400">NO RESULTS</div>'; return; }
                data.results.forEach(r => {
                    const d = document.createElement('div');
                    d.className = "bg-slate-50 p-6 rounded-2xl flex justify-between items-center active:scale-95 transition-all";
                    d.innerHTML = `
                        <div class="min-w-0 flex-grow">
                            <div class="font-black text-slate-900 truncate text-lg">${r.name}</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase truncate">${r.admin1||''}, ${r.country}</div>
                        </div>
                        <div class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase">${t('add')}</div>
                    `;
                    d.onclick = () => {
                        const newId = 'loc_'+Date.now();
                        const newLoc = { id: newId, name: r.name, lat: r.latitude, lon: r.longitude };
                        STATE.locations.push(newLoc);
                        localStorage.setItem('wy_v5_locs', JSON.stringify(STATE.locations));
                        toggleSearch(false);
                        switchLocation(newId);
                    };
                    resBox.appendChild(d);
                });
            } catch(e) { resBox.innerHTML = 'Error.'; }
        }

        function setLang(l) {
            STATE.lang = l;
            localStorage.setItem('wy_v5_lang', l);
            updateUIStrings();
            renderLocationBar();
            refresh();
        }

        function manualModelChange(m) {
            STATE.model = m;
            localStorage.setItem('wy_v5_model', m);
            switchLocation(STATE.activeId);
        }

        function updateUIStrings() {
            document.getElementById('ui-date').innerText = new Date().toLocaleDateString(STATE.lang === 'zh' ? 'zh-TW' : (STATE.lang === 'ja' ? 'ja-JP' : 'en-US'), { month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('ui-search-title').innerText = t('search_title');
            document.getElementById('ui-cancel').innerText = t('cancel');
            document.getElementById('ui-lbl-feels').innerText = t('feels_short');
            document.getElementById('ui-lbl-feels-yest').innerText = t('feels_short');
            document.getElementById('ui-lbl-rain').innerText = t('rain');
            document.getElementById('ui-lbl-wind').innerText = t('wind');
            document.getElementById('ui-lbl-yesterday').innerText = t('yesterday');
            document.getElementById('ui-lbl-today').innerText = t('today');
            document.getElementById('ui-lbl-12h').innerText = t('h12');
            document.getElementById('ui-lbl-8d').innerText = t('d8');
            document.getElementById('ui-lbl-14d').innerText = t('d14');
            document.getElementById('model-select').value = STATE.model;

            ['zh', 'ja', 'en'].forEach(l => {
                const b = document.getElementById(`btn-${l}`);
                if (b) b.className = `px-4 py-2 rounded-xl text-[10px] font-black transition-all ${STATE.lang === l ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`;
            });
        }

        window.onload = () => {
            updateUIStrings();
            switchLocation(STATE.activeId);
        };
    </script>
</body>
</html>
