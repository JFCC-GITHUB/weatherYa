<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zenith 5.0 - Prism Pro</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --accent-blue: #0066FF;
            --accent-red: #FF3B30;
            --accent-green: #34C759;
            --bg-pure: #FFFFFF;
            --card-bg: #F2F2F7;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: "Inter", "Noto Sans TC", "Noto Sans JP", sans-serif;
        }

        body {
            background-color: var(--bg-pure);
            color: #1C1C1E;
            margin: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .glass-card {
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            background: #F2F2F7;
            color: #8E8E93;
        }

        .btn-action.active {
            background: var(--accent-blue);
            color: white;
        }

        #mini-map {
            width: 100px;
            height: 100px;
            border-radius: 18px;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 10;
        }

        .loader {
            position: fixed; inset: 0; z-index: 9999;
            background: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- Loading Screen -->
    <div id="loader" class="loader">
        <div class="w-12 h-12 border-[5px] border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-black tracking-widest text-slate-400 uppercase">Zenith 5.0 - Prism Pro</p>
    </div>

    <!-- Search UI -->
    <div id="search-modal" class="fixed inset-0 z-[5000] hidden bg-white p-6 pt-12 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 id="ui-search-title" class="text-3xl font-black">---</h2>
                <button onclick="toggleSearch(false)" class="text-slate-400 font-bold" id="ui-cancel">---</button>
            </div>
            <div class="flex gap-2 mb-8">
                <input type="text" id="search-input" class="flex-grow bg-slate-100 rounded-2xl px-6 py-4 outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="...">
                <button onclick="performSearch()" class="bg-black text-white px-6 py-4 rounded-2xl font-black">Search</button>
            </div>
            <div id="search-results" class="space-y-4"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-md mx-auto px-5 py-8 space-y-6">
        
        <!-- Header: Control Panel -->
        <header class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button onclick="setLang('zh')" id="btn-zh" class="px-3 py-1.5 rounded-lg text-xs font-black transition-all">ä¸­</button>
                    <button onclick="setLang('ja')" id="btn-ja" class="px-3 py-1.5 rounded-lg text-xs font-black transition-all">æ—¥</button>
                    <button onclick="setLang('en')" id="btn-en" class="px-3 py-1.5 rounded-lg text-xs font-black transition-all">EN</button>
                </div>
                <div class="text-right">
                    <div id="final-model-badge" class="inline-block px-2 py-0.5 rounded-md bg-blue-50 text-blue-600 text-[10px] font-black uppercase">---</div>
                    <select id="model-select" onchange="manualModelChange(this.value)" class="block mt-1 text-[10px] font-bold text-slate-400 bg-transparent border-none outline-none text-right w-full">
                        <option value="auto">AUTO</option>
                        <option value="jma_seamless">JMA</option>
                        <option value="kma_local">KMA</option>
                        <option value="ecmwf_ifs025">ECMWF</option>
                        <option value="gfs_global">GFS</option>
                    </select>
                </div>
            </div>

            <div id="location-scroll" class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                <!-- Location Pills Inject Here -->
            </div>
        </header>

        <!-- Current Weather & Mini Map -->
        <section class="glass-card p-6">
            <div class="flex justify-between items-start gap-4">
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="ui-now-tag" class="text-[10px] font-black bg-blue-600 text-white px-2 py-0.5 rounded uppercase">---</span>
                        <span id="current-time" class="text-[10px] font-bold text-slate-400">--:--</span>
                    </div>
                    <h1 id="city-name" class="text-3xl font-black tracking-tight text-slate-900 truncate">---</h1>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="curr-temp" class="text-6xl font-black tracking-tighter">--</span>
                        <span class="text-xl font-black text-blue-500">Â°C</span>
                    </div>
                </div>
                <div id="mini-map"></div>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-8">
                <div class="bg-slate-50 p-3 rounded-2xl text-center">
                    <div id="ui-label-feels" class="text-[9px] font-bold text-slate-400 uppercase">---</div>
                    <div class="text-sm font-black text-slate-800"><span id="curr-feels">--</span>Â°C</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-2xl text-center">
                    <div id="ui-label-rain" class="text-[9px] font-bold text-slate-400 uppercase">---</div>
                    <div class="text-sm font-black text-blue-600"><span id="curr-rain">--</span>mm</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-2xl text-center">
                    <div id="ui-label-wind" class="text-[9px] font-bold text-slate-400 uppercase">---</div>
                    <div class="text-sm font-black text-slate-800"><span id="curr-wind">--</span><span class="text-[8px] ml-0.5">km/h</span></div>
                </div>
            </div>
        </section>

        <!-- Comparison: Yesterday & Today -->
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card p-4">
                <div id="ui-label-yesterday" class="text-[10px] font-black text-slate-400 mb-3 uppercase">---</div>
                <div class="flex justify-between items-center">
                    <span id="yes-emoji" class="text-3xl">--</span>
                    <div class="text-right">
                        <div class="text-sm font-black text-slate-700"><span id="yes-hilo">--/--</span>Â°</div>
                        <div class="text-[9px] font-bold text-slate-400">ðŸ’¨ <span id="yes-wind">--</span></div>
                    </div>
                </div>
            </div>
            <div class="glass-card p-4 border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-3">
                    <div id="ui-label-today" class="text-[10px] font-black text-blue-500 uppercase">---</div>
                    <div id="today-diff" class="text-[9px] font-black px-1.5 py-0.5 rounded bg-blue-50 text-blue-600">--</div>
                </div>
                <div class="flex justify-between items-center">
                    <span id="today-emoji" class="text-3xl">--</span>
                    <div class="text-right">
                        <div class="text-sm font-black text-slate-700"><span id="today-hilo">--/--</span>Â°</div>
                        <div class="text-[9px] font-bold text-blue-500">ðŸ’§ <span id="today-rain-prob">--</span>%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hourly Forecast (12H) -->
        <section class="glass-card p-5 overflow-hidden">
            <h3 id="ui-label-12h" class="text-xs font-black text-slate-400 mb-6 uppercase">---</h3>
            <div class="overflow-x-auto no-scrollbar">
                <div id="hourly-icons" class="flex justify-between mb-1 px-4 min-w-[650px]"></div>
                <div class="h-52 min-w-[650px]">
                    <canvas id="chart-hourly"></canvas>
                </div>
            </div>
        </section>

        <!-- 8 Day Trend -->
        <section class="glass-card p-5 overflow-hidden">
            <h3 id="ui-label-8d" class="text-xs font-black text-slate-400 mb-6 uppercase">---</h3>
            <div class="overflow-x-auto no-scrollbar">
                <div id="daily-icons" class="flex justify-between mb-1 px-4 min-w-[550px]"></div>
                <div class="h-52 min-w-[550px]">
                    <canvas id="chart-daily"></canvas>
                </div>
            </div>
        </section>

        <!-- 14 Day Detailed List -->
        <section id="list-14d" class="space-y-3 pb-8"></section>

    </main>

    <script>
        // --- I18N Configuration ---
        const I18N = {
            zh: {
                search_title: "æœå°‹åœ°é»ž", cancel: "å–æ¶ˆ", now: "ç¾åœ¨", feels: "é«”æ„Ÿ", rain: "é™é›¨", wind: "é¢¨é€Ÿ",
                yesterday: "æ˜¨æ—¥å›žé¡§", today: "ä»Šæ—¥é å ±", h12: "12å°æ™‚é å ±", d8: "8æ—¥æ°£æº«è¶¨å‹¢",
                current_loc: "ç›®å‰ä½ç½®", search_placeholder: "åŸŽå¸‚ã€è¡Œæ”¿å€...",
                cities: { zhubei: "ç«¹åŒ—", taichung: "å°ä¸­", taipei: "å°åŒ—", osaka: "å¤§é˜ª" }
            },
            en: {
                search_title: "Search Location", cancel: "Cancel", now: "NOW", feels: "FEELS", rain: "RAIN", wind: "WIND",
                yesterday: "YESTERDAY", today: "TODAY", h12: "12-HOUR TREND", d8: "8-DAY TREND",
                current_loc: "MY LOCATION", search_placeholder: "City, area...",
                cities: { zhubei: "Zhubei", taichung: "Taichung", taipei: "Taipei", osaka: "Osaka" }
            },
            ja: {
                search_title: "å ´æ‰€ã‚’æ¤œç´¢", cancel: "æˆ»ã‚‹", now: "ç¾åœ¨", feels: "ä½“æ„Ÿ", rain: "é™æ°´", wind: "é¢¨é€Ÿ",
                yesterday: "æ˜¨æ—¥", today: "ä»Šæ—¥", h12: "12æ™‚é–“äºˆå ±", d8: "8æ—¥é–“æŽ¨ç§»",
                current_loc: "ç¾åœ¨åœ°", search_placeholder: "éƒ½å¸‚åã‚’å…¥åŠ›...",
                cities: { zhubei: "ç«¹åŒ—", taichung: "å°ä¸­å›½", taipei: "å°åŒ—", osaka: "å¤§é˜ª" }
            }
        };

        const STATE = {
            lang: localStorage.getItem('zenith_lang') || 'zh',
            activeId: 'gps',
            coords: { lat: 24.83, lon: 121.01 },
            model: 'auto',
            locations: JSON.parse(localStorage.getItem('zenith_locs_v5')) || [
                { id: 'gps', name: 'current_loc', lat: null, lon: null },
                { id: 'zhubei', name: 'cities.zhubei', lat: 24.83, lon: 121.01 },
                { id: 'taichung', name: 'cities.taichung', lat: 24.23, lon: 120.67 },
                { id: 'taipei', name: 'cities.taipei', lat: 25.03, lon: 121.56 },
                { id: 'osaka', name: 'cities.osaka', lat: 34.69, lon: 135.50 }
            ],
            charts: {},
            map: null,
            marker: null
        };

        // Register Chart.js DataLabels plugin
        Chart.register(ChartDataLabels);

        function getTranslation(key) {
            const keys = key.split('.');
            let val = I18N[STATE.lang];
            keys.forEach(k => val = val ? val[k] : key);
            return val || key;
        }

        async function safeApiFetch(url, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Fetch Failed");
                    return await res.json();
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        function determineModel(lat, lon) {
            if (lat >= 21.8 && lat <= 25.5 && lon >= 119.5 && lon <= 122.5) return 'jma_seamless';
            if (lat >= 24 && lat <= 46 && lon >= 123 && lon <= 149) return 'jma_seamless';
            if (lat >= 33 && lat <= 39 && lon >= 124 && lon <= 130) return 'kma_local';
            if (lat >= 35 && lat <= 70 && lon >= -10 && lon <= 40) return 'ecmwf_ifs04';
            if (lat >= 25 && lat <= 50 && lon >= -125 && lon <= -65) return 'gfs_global';
            
            const centers = [
                { id: 'jma_seamless', lat: 35, lon: 139 },
                { id: 'kma_local', lat: 37, lon: 127 },
                { id: 'ecmwf_ifs04', lat: 48, lon: 2 },
                { id: 'gfs_global', lat: 40, lon: -100 }
            ];
            let nearest = centers[0];
            let minDist = Infinity;
            centers.forEach(c => {
                const d = Math.sqrt(Math.pow(lat - c.lat, 2) + Math.pow(lon - c.lon, 2));
                if (d < minDist) { minDist = d; nearest = c; }
            });
            return nearest.id;
        }

        function getEmoji(code) {
            if (code === undefined || code === null) return 'â“';
            if (code <= 1) return 'â˜€ï¸';
            if (code <= 3) return 'ðŸŒ¤ï¸';
            if (code <= 48) return 'ðŸŒ«ï¸';
            if (code <= 55) return 'ðŸŒ¦ï¸';
            if (code <= 67) return 'ðŸŒ§ï¸';
            if (code <= 77) return 'â„ï¸';
            if (code <= 82) return 'ðŸŒ§ï¸';
            if (code <= 99) return 'â›ˆï¸';
            return 'â˜ï¸';
        }

        function updateStaticText() {
            document.getElementById('ui-search-title').innerText = getTranslation('search_title');
            document.getElementById('ui-cancel').innerText = getTranslation('cancel');
            document.getElementById('search-input').placeholder = getTranslation('search_placeholder');
            document.getElementById('ui-now-tag').innerText = getTranslation('now');
            document.getElementById('ui-label-feels').innerText = getTranslation('feels');
            document.getElementById('ui-label-rain').innerText = getTranslation('rain');
            document.getElementById('ui-label-wind').innerText = getTranslation('wind');
            document.getElementById('ui-label-yesterday').innerText = getTranslation('yesterday');
            document.getElementById('ui-label-today').innerText = getTranslation('today');
            document.getElementById('ui-label-12h').innerText = getTranslation('h12');
            document.getElementById('ui-label-8d').innerText = getTranslation('d8');

            ['zh', 'ja', 'en'].forEach(l => {
                const btn = document.getElementById(`btn-${l}`);
                btn.classList.toggle('bg-white', STATE.lang === l);
                btn.classList.toggle('shadow-sm', STATE.lang === l);
                btn.classList.toggle('text-blue-600', STATE.lang === l);
                btn.classList.toggle('text-slate-400', STATE.lang !== l);
            });
        }

        function renderLocationBar() {
            const container = document.getElementById('location-scroll');
            container.innerHTML = '';
            STATE.locations.forEach(loc => {
                const btn = document.createElement('button');
                btn.className = `btn-action whitespace-nowrap ${STATE.activeId === loc.id ? 'active' : ''}`;
                btn.innerText = getTranslation(loc.name);
                btn.onclick = () => switchLocation(loc.id);
                container.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = "btn-action border-dashed border-2 border-slate-200 text-slate-300";
            addBtn.innerText = "+";
            addBtn.onclick = () => toggleSearch(true);
            container.appendChild(addBtn);
        }

        async function switchLocation(id) {
            STATE.activeId = id;
            const loc = STATE.locations.find(l => l.id === id);
            if (id === 'gps') {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        STATE.coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        initRefresh();
                    },
                    err => {
                        STATE.coords = { lat: 24.83, lon: 121.01 };
                        initRefresh();
                    }
                );
            } else {
                STATE.coords = { lat: loc.lat, lon: loc.lon };
                initRefresh();
            }
            renderLocationBar();
        }

        function initRefresh() {
            document.getElementById('loader').style.display = 'flex';
            refreshWeather();
        }

        async function refreshWeather() {
            const { lat, lon } = STATE.coords;
            const selectedModel = STATE.model === 'auto' ? determineModel(lat, lon) : STATE.model;
            document.getElementById('final-model-badge').innerText = selectedModel.split('_')[0];

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,precipitation,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_probability_max,windspeed_10m_max&timezone=auto&past_days=1&forecast_days=14&models=${selectedModel}`;

            try {
                const data = await safeApiFetch(url);
                const h = data.hourly;
                const d = data.daily;
                const nowHour = new Date().getHours();
                const nowIdx = 24 + nowHour;

                document.getElementById('curr-temp').innerText = Math.round(h.temperature_2m[nowIdx] ?? 0);
                document.getElementById('curr-feels').innerText = Math.round(h.apparent_temperature[nowIdx] ?? 0);
                document.getElementById('curr-rain').innerText = (h.precipitation[nowIdx] ?? 0).toFixed(1);
                document.getElementById('current-time').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

                document.getElementById('yes-emoji').innerText = getEmoji(d.weathercode[0]);
                document.getElementById('yes-hilo').innerText = `${Math.round(d.temperature_2m_max[0] ?? 0)}/${Math.round(d.temperature_2m_min[0] ?? 0)}`;
                document.getElementById('yes-wind').innerText = Math.round(d.windspeed_10m_max[0] ?? 0) + "km/h";

                document.getElementById('today-emoji').innerText = getEmoji(d.weathercode[1]);
                document.getElementById('today-hilo').innerText = `${Math.round(d.temperature_2m_max[1] ?? 0)}/${Math.round(d.temperature_2m_min[1] ?? 0)}`;
                document.getElementById('today-rain-prob').innerText = Math.round(d.precipitation_probability_max[1] ?? 0);
                
                const diff = Math.round((d.temperature_2m_max[1] ?? 0) - (d.temperature_2m_max[0] ?? 0));
                const diffEl = document.getElementById('today-diff');
                diffEl.innerText = (diff >= 0 ? '+' : '') + diff + 'Â°';
                diffEl.className = `text-[9px] font-black px-1.5 py-0.5 rounded ${diff >= 0 ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`;
                document.getElementById('curr-wind').innerText = Math.round(d.windspeed_10m_max[1] / 1.5);

                updateMap(lat, lon);
                reverseGeocode(lat, lon);
                renderHourlyChart(h, nowIdx);
                renderDailyChart(d);
                render14DList(d);

            } catch (err) {
                console.error(err);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function updateMap(lat, lon) {
            if (!STATE.map) {
                STATE.map = L.map('mini-map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(STATE.map);
                STATE.marker = L.marker([lat, lon]).addTo(STATE.map);
            } else {
                STATE.map.setView([lat, lon], 9);
                STATE.marker.setLatLng([lat, lon]);
            }
            setTimeout(() => STATE.map.invalidateSize(), 300);
        }

        async function reverseGeocode(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=${STATE.lang}`);
                const data = await res.json();
                const name = data.address.city || data.address.town || data.address.village || data.address.suburb || "STATION";
                document.getElementById('city-name').innerText = name.toUpperCase();
            } catch (e) {
                document.getElementById('city-name').innerText = "STATION";
            }
        }

        function renderHourlyChart(h, startIdx) {
            const labels = [], temps = [], feels = [], rain = [];
            const iconBox = document.getElementById('hourly-icons');
            iconBox.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                const idx = startIdx + i;
                if (!h.time[idx]) break;
                labels.push(new Date(h.time[idx]).getHours() + ":00");
                temps.push(h.temperature_2m[idx] ?? 0);
                feels.push(h.apparent_temperature[idx] ?? 0);
                rain.push(h.precipitation[idx] ?? 0);
                
                const ic = document.createElement('span');
                ic.className = "w-10 text-center text-sm";
                ic.innerText = getEmoji(h.weathercode[idx]);
                iconBox.appendChild(ic);
            }

            if (STATE.charts.hourly) STATE.charts.hourly.destroy();
            STATE.charts.hourly = new Chart(document.getElementById('chart-hourly'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Temp', data: temps, borderColor: '#0066FF', borderWidth: 3, tension: 0.4, yAxisID: 'y', pointRadius: 4, pointBackgroundColor: 'white' },
                        { label: 'Feel', data: feels, borderColor: '#C7C7CC', borderWidth: 2, borderDash: [4,4], tension: 0.4, yAxisID: 'y', pointRadius: 0 },
                        { label: 'Rain', data: rain, type: 'bar', backgroundColor: 'rgba(0, 102, 255, 0.2)', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 25 } },
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            display: (context) => context.dataset.type === 'bar' ? (context.dataset.data[context.dataIndex] > 0) : true,
                            align: 'top',
                            offset: 4,
                            font: { size: 10, weight: 'bold' },
                            color: (context) => context.dataset.type === 'bar' ? '#0066FF' : '#1C1C1E',
                            formatter: (v, c) => c.dataset.type === 'bar' ? v.toFixed(1) : Math.round(v) + 'Â°'
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '20%' }, 
                        y1: { display: false, position: 'right', max: Math.max(...rain, 5) * 1.5 }, 
                        x: { grid: { display: false }, border: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    }
                }
            });
        }

        function renderDailyChart(d) {
            const labels = [], maxs = [], mins = [], rain = [];
            const iconBox = document.getElementById('daily-icons');
            iconBox.innerHTML = '';

            for (let i = 0; i < 8; i++) {
                if (!d.time[i]) break;
                labels.push(d.time[i].split('-').slice(1).join('/'));
                maxs.push(d.temperature_2m_max[i] ?? 0);
                mins.push(d.temperature_2m_min[i] ?? 0);
                rain.push(d.precipitation_sum[i] ?? 0);

                const ic = document.createElement('span');
                ic.className = "w-10 text-center text-sm";
                ic.innerText = getEmoji(d.weathercode[i]);
                iconBox.appendChild(ic);
            }

            if (STATE.charts.daily) STATE.charts.daily.destroy();
            STATE.charts.daily = new Chart(document.getElementById('chart-daily'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Max', data: maxs, borderColor: '#FF3B30', borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: 'white' },
                        { label: 'Min', data: mins, borderColor: '#007AFF', borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: 'white' },
                        { label: 'Rain', data: rain, type: 'bar', backgroundColor: 'rgba(0, 122, 255, 0.15)', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 25 } },
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            display: (context) => context.dataset.type === 'bar' ? (context.dataset.data[context.dataIndex] > 0) : true,
                            align: (context) => context.dataset.label === 'Min' ? 'bottom' : 'top',
                            offset: 6,
                            font: { size: 10, weight: 'bold' },
                            color: (context) => {
                                if (context.dataset.type === 'bar') return '#0066FF';
                                return context.dataset.label === 'Max' ? '#FF3B30' : '#007AFF';
                            },
                            formatter: (v, c) => c.dataset.type === 'bar' ? v.toFixed(1) : Math.round(v) + 'Â°'
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '20%' }, 
                        y1: { display: false, position: 'right', max: Math.max(...rain, 10) * 1.5 },
                        x: { grid: { display: false }, border: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    }
                }
            });
        }

        function render14DList(d) {
            const container = document.getElementById('list-14d');
            container.innerHTML = '';
            for (let i = 1; i < 15; i++) {
                if (!d.time[i]) break;
                const max = d.temperature_2m_max[i] ?? 0;
                const min = d.temperature_2m_min[i] ?? 0;
                const rain = d.precipitation_sum[i] ?? 0;
                const wind = d.windspeed_10m_max[i] ?? 0;
                const diff = Math.round(max - (d.temperature_2m_max[i-1] ?? max));
                const dateObj = new Date(d.time[i]);
                const dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                const dayStr = dateObj.toLocaleDateString(STATE.lang === 'zh' ? 'zh-TW' : (STATE.lang === 'ja' ? 'ja-JP' : 'en-US'), { weekday: 'short' });

                const card = document.createElement('div');
                card.className = "glass-card p-4 flex items-center justify-between";
                card.innerHTML = `
                    <div class="w-14">
                        <div class="text-[10px] font-black text-slate-400 leading-none">${dateStr}</div>
                        <div class="text-xs font-bold text-slate-800">${dayStr}</div>
                    </div>
                    <div class="text-3xl mx-2">${getEmoji(d.weathercode[i])}</div>
                    <div class="flex-grow flex flex-col items-center">
                        <div class="text-sm font-black text-slate-800">${Math.round(max)}Â° / ${Math.round(min)}Â°</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">TEMP DIFF <span class="${diff >= 0 ? 'text-red-500' : 'text-blue-500'}">${diff >= 0 ? '+' : ''}${diff}Â°</span></div>
                    </div>
                    <div class="text-right w-16">
                        <div class="text-[10px] font-black text-blue-500">${rain.toFixed(1)}mm</div>
                        <div class="text-[9px] font-bold text-slate-300">${Math.round(wind)}km/h</div>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function setLang(l) {
            STATE.lang = l;
            localStorage.setItem('zenith_lang', l);
            updateStaticText();
            renderLocationBar();
            refreshWeather();
        }

        function toggleSearch(show) {
            document.getElementById('search-modal').classList.toggle('hidden', !show);
            if (show) document.getElementById('search-input').focus();
        }

        async function performSearch() {
            const q = document.getElementById('search-input').value;
            if (!q) return;
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=${STATE.lang}`);
            const data = await res.json();
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            (data.results || []).forEach(r => {
                const div = document.createElement('div');
                div.className = "glass-card p-5 flex justify-between items-center cursor-pointer active:scale-95 transition";
                div.innerHTML = `
                    <div>
                        <div class="font-black text-lg">${r.name}</div>
                        <div class="text-xs text-slate-400 font-bold">${r.admin1 || ''}, ${r.country}</div>
                    </div>
                    <div class="text-blue-500 font-black text-xs uppercase">Add</div>
                `;
                div.onclick = () => {
                    const newLoc = { id: 'loc_' + Date.now(), name: r.name, lat: r.latitude, lon: r.longitude };
                    STATE.locations.push(newLoc);
                    localStorage.setItem('zenith_locs_v5', JSON.stringify(STATE.locations));
                    toggleSearch(false);
                    switchLocation(newLoc.id);
                };
                results.appendChild(div);
            });
        }

        function manualModelChange(m) {
            STATE.model = m;
            initRefresh();
        }

        window.onload = () => {
            updateStaticText();
            switchLocation(STATE.activeId);
        };
    </script>
</body>
</html>
