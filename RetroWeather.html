<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RetroWeather Zenith</title>
    
    <!-- æ ¸å¿ƒè³‡æºï¼šTailwind CSS, Chart.js, Leaflet -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --bg-main: #0a0a0c;
            --accent: #3b82f6;
            --card-bg: rgba(23, 23, 26, 0.8);
        }

        body {
            background-color: var(--bg-main);
            color: #f8fafc;
            font-family: "Inter", "Noto Sans TC", "Noto Sans JP", sans-serif;
            letter-spacing: -0.01em;
        }

        .zenith-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            overflow: hidden;
        }

        .btn-pill {
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 800;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        #map {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 20px;
            filter: grayscale(0.2) contrast(1.1);
        }

        .diff-up { color: #f87171; }
        .diff-down { color: #60a5fa; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* å‹•æ…‹è¼‰å…¥å‹•ç•« */
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loader-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-12 pb-24">

    <div id="loader" class="loader-screen">
        <div class="w-12 h-12 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin mb-6"></div>
        <div id="loader-text" class="text-[10px] font-black tracking-[0.5em] text-blue-500 uppercase">Synchronizing Satellite Data...</div>
    </div>

    <!-- æœå°‹è¦–çª— -->
    <div id="search-modal" class="fixed inset-0 z-[5000] hidden items-center justify-center bg-black/80 backdrop-blur-xl p-4">
        <div class="zenith-card p-6 w-full max-w-lg shadow-2xl">
            <h2 id="ui-search-title" class="text-xl font-black mb-4">æ–°å¢åœ°é»</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="search-input" class="flex-grow bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-blue-500" placeholder="...">
                <button onclick="performSearch()" class="bg-blue-600 px-6 py-3 rounded-xl font-black active:scale-95 transition">Go</button>
            </div>
            <div id="search-results" class="max-h-60 overflow-y-auto space-y-2 no-scrollbar"></div>
            <button onclick="toggleSearch(false)" class="w-full mt-4 py-2 text-white/40 font-bold hover:text-white" id="ui-cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <header class="max-w-7xl mx-auto mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8">
            <!-- èªç³»åˆ‡æ› -->
            <div class="flex gap-2">
                <button onclick="changeLang('zh')" id="lang-zh" class="btn-pill">æ­£é«”ä¸­æ–‡</button>
                <button onclick="changeLang('ja')" id="lang-ja" class="btn-pill">æ—¥æœ¬èª</button>
                <button onclick="changeLang('en')" id="lang-en" class="btn-pill">ENGLISH</button>
            </div>

            <!-- æ¨¡å‹é¡¯ç¤ºèˆ‡åˆ‡æ› -->
            <div class="flex flex-col items-end gap-1">
                <div class="flex items-center gap-3">
                    <span id="ui-model-label" class="text-[10px] font-black opacity-30 uppercase tracking-widest">Model Engine</span>
                    <select id="model-selector" onchange="manualModel(this.value)" class="bg-blue-600/10 border border-blue-500/30 text-blue-400 text-xs font-black px-3 py-1.5 rounded-lg outline-none cursor-pointer">
                        <option value="auto">AUTO (æ™ºæ…§åˆ¤å®š)</option>
                        <option value="jma_seamless">JMA (æ—¥æœ¬æ°£è±¡å»³)</option>
                        <option value="kma_deterministic">KMA (éŸ“åœ‹æ°£è±¡å»³)</option>
                        <option value="ecmwf_ifs04">ECMWF (æ­æ´²ä¸­å¿ƒ)</option>
                        <option value="gfs_seamless">GFS (ç¾åœ‹å…¨çƒ)</option>
                    </select>
                </div>
                <div id="final-model-badge" class="text-[9px] font-mono text-blue-500/60 uppercase">Determining Optimum Path...</div>
            </div>
        </div>

        <!-- åœ°é»å°è¦½ -->
        <div class="flex items-center gap-3 overflow-x-auto no-scrollbar pb-2">
            <div id="location-bar" class="flex gap-3"></div>
            <button onclick="toggleSearch(true)" class="w-10 h-10 flex-shrink-0 bg-white/5 border border-white/10 rounded-full flex items-center justify-center hover:bg-white/10 transition">ï¼‹</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto space-y-8">
        <!-- ç¬¬ä¸€å€å¡Šï¼šç•¶å‰æ°£å€™èˆ‡åœ°åœ– -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 zenith-card p-8 md:p-12 flex flex-col justify-between min-h-[400px]">
                <div>
                    <h1 id="display-city" class="text-4xl md:text-6xl font-black tracking-tighter mb-2">---</h1>
                    <p id="display-time" class="text-xs font-bold opacity-30 uppercase tracking-[0.3em] mb-8">---</p>
                    
                    <div class="flex items-center gap-8">
                        <div id="main-emoji" class="text-7xl md:text-9xl">â˜€ï¸</div>
                        <div>
                            <div class="flex items-start">
                                <span id="main-temp" class="text-7xl md:text-9xl font-black tracking-tighter">--</span>
                                <span class="text-3xl font-black mt-4 ml-1 text-blue-500">Â°</span>
                            </div>
                            <div class="text-sm font-bold opacity-50"><span id="ui-feels">é«”æ„Ÿ</span> <span id="main-feels">--</span>Â°C</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-12">
                    <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                        <div id="ui-rain-label" class="text-[9px] font-black opacity-30 uppercase tracking-widest mb-1">é™é›¨é‡</div>
                        <div class="text-2xl font-black text-blue-400">ğŸ’§ <span id="main-rain">--</span><span class="text-xs ml-1 opacity-50">mm</span></div>
                    </div>
                    <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                        <div id="ui-wind-label" class="text-[9px] font-black opacity-30 uppercase tracking-widest mb-1">é¢¨é€Ÿ</div>
                        <div class="text-2xl font-black text-emerald-400">ğŸ’¨ <span id="main-wind">--</span><span class="text-xs ml-1 opacity-50">km/h</span></div>
                    </div>
                </div>
            </div>

            <!-- å½©è‰²éœæ…‹åœ°åœ–æ›¿ä»£å€ (ä½¿ç”¨ Leaflet å³æ™‚æ¸²æŸ“) -->
            <div class="zenith-card p-4 flex flex-col items-center">
                <div id="map"></div>
                <div class="mt-4 text-[9px] font-black opacity-20 uppercase tracking-[0.4em]">Geo-Layer Level 09 / Active Rendering</div>
            </div>
        </section>

        <!-- ç¬¬äºŒå€å¡Šï¼šæ˜¨æ—¥èˆ‡ä»Šæ—¥ -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- æ˜¨æ—¥ -->
            <div class="zenith-card p-6 border-l-4 border-white/20">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="ui-yesterday" class="text-[10px] font-black opacity-40 uppercase tracking-widest">æ˜¨æ—¥å›é¡§</h3>
                    <span id="date-yes" class="text-[10px] font-mono opacity-20">---</span>
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-5xl opacity-20">ğŸ•°ï¸</div>
                    <div class="text-right">
                        <div class="text-2xl font-black"><span id="yes-hilo">-- / --</span>Â°C</div>
                        <div class="text-[10px] font-bold opacity-30 mt-1">Feels <span id="yes-feels-hilo">-- / --</span>Â°C</div>
                        <div class="flex gap-4 justify-end mt-3 text-[10px] font-black opacity-40">
                            <span>ğŸ’§ <span id="yes-rain">--</span> mm</span>
                            <span>ğŸ’¨ <span id="yes-wind">--</span> km/h</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ä»Šæ—¥ -->
            <div class="zenith-card p-6 border-l-4 border-blue-500 shadow-xl shadow-blue-500/5">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="ui-today" class="text-[10px] font-black text-blue-500 uppercase tracking-widest">ä»Šæ—¥é å ±</h3>
                    <div id="temp-diff-tag" class="text-[10px] font-black px-2 py-0.5 rounded bg-blue-500/10">--</div>
                </div>
                <div class="flex justify-between items-end">
                    <div id="today-emoji" class="text-5xl">â˜€ï¸</div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-blue-400"><span id="today-hilo">-- / --</span>Â°C</div>
                        <div class="text-[10px] font-bold opacity-30 mt-1">Feels <span id="today-feels-hilo">-- / --</span>Â°C</div>
                        <div class="flex gap-4 justify-end mt-3 text-[10px] font-black text-blue-400">
                            <span>ğŸ’§ <span id="today-rain">--</span> mm</span>
                            <span>ğŸ’¨ <span id="today-wind">--</span> km/h</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¬¬ä¸‰å€å¡Šï¼š12å°æ™‚è¶¨å‹¢ -->
        <section>
            <h3 id="ui-hourly-title" class="px-4 text-[10px] font-black uppercase tracking-[0.3em] text-blue-500 mb-4 flex items-center gap-2">
                <span class="w-4 h-[2px] bg-blue-500"></span> 12å°æ™‚è¶¨å‹¢é å ±
            </h3>
            <div class="zenith-card p-6 overflow-x-auto no-scrollbar">
                <div class="h-64 min-w-[800px]">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- ç¬¬å››å€å¡Šï¼š8æ—¥æŠ˜ç·šåœ– -->
        <section>
            <h3 id="ui-8day-title" class="px-4 text-[10px] font-black uppercase tracking-[0.3em] text-amber-500 mb-4 flex items-center gap-2">
                <span class="w-4 h-[2px] bg-amber-500"></span> 8æ—¥è¶¨å‹¢åˆ†æ (å«æ˜¨æ—¥)
            </h3>
            <div class="zenith-card p-6">
                <div class="h-80 w-full">
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- ç¬¬äº”å€å¡Šï¼š14æ—¥æ·±åº¦é å ± -->
        <section>
            <h3 id="ui-14day-title" class="px-4 text-[10px] font-black uppercase tracking-[0.3em] text-blue-500 mb-4 flex items-center gap-2">
                <span class="w-4 h-[2px] bg-blue-500"></span> 14æ—¥æ·±åº¦é å ±
            </h3>
            <div id="forecast-list" class="space-y-3"></div>
        </section>
    </main>

    <script>
        /**
         * RetroWeather Zenith Engine
         * è³‡æ–™å‡ºè™•ï¼šOpen-Meteo API, Nominatim Geocoding API
         */

        const I18N = {
            zh: {
                current_loc: "ç›®å‰ä½ç½®", zhubei: "ç«¹åŒ—", taichung: "å°ä¸­", taipei: "å°åŒ—", osaka: "å¤§é˜ª",
                feels: "é«”æ„Ÿ", rain: "é™é›¨é‡", wind: "é¢¨é€Ÿ", yesterday: "æ˜¨æ—¥å›é¡§", today: "ä»Šæ—¥é å ±",
                hourly: "12å°æ™‚è¶¨å‹¢é å ±", d8: "8æ—¥è¶¨å‹¢åˆ†æ (å«æ˜¨æ—¥)", d14: "14æ—¥æ·±åº¦é å ±",
                diff_vs: "è¼ƒå‰æ—¥", search_title: "æ–°å¢åœ°é»", cancel: "å–æ¶ˆ",
                searching: "æœå°‹ä¸­...", no_results: "æŸ¥ç„¡çµæœ", search_placeholder: "è«‹è¼¸å…¥åŸå¸‚åç¨±...",
                temp: "æ°£æº«", feels_label: "é«”æ„Ÿé«˜ä½æº«"
            },
            en: {
                current_loc: "Current", zhubei: "Zhubei", taichung: "Taichung", taipei: "Taipei", osaka: "Osaka",
                feels: "Feels", rain: "Rain", wind: "Wind", yesterday: "Yesterday", today: "Today",
                hourly: "12-Hour Trend", d8: "8-Day Trend (Inc. Past)", d14: "14-Day Deep Forecast",
                diff_vs: "vs Prev", search_title: "Add Location", cancel: "Cancel",
                searching: "Searching...", no_results: "No results", search_placeholder: "Enter city name...",
                temp: "Temp", feels_label: "Feels H/L"
            },
            ja: {
                current_loc: "ç¾åœ¨åœ°", zhubei: "ç«¹åŒ—", taichung: "å°ä¸­å›½", taipei: "å°åŒ—", osaka: "å¤§é˜ª",
                feels: "ä½“æ„Ÿ", rain: "é™æ°´é‡", wind: "é¢¨é€Ÿ", yesterday: "æ˜¨æ—¥ã®å›é¡§", today: "ä»Šæ—¥ã®äºˆå ±",
                hourly: "12æ™‚é–“è¶¨å‹¢", d8: "8æ—¥é–“ãƒˆãƒ¬ãƒ³ãƒ‰ (æ˜¨æ—¥å«ã‚€)", d14: "14æ—¥é–“è©³ç´°äºˆå ±",
                diff_vs: "å‰æ—¥æ¯”", search_title: "åœ°ç‚¹è¿½åŠ ", cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
                searching: "æ¤œç´¢ä¸­...", no_results: "çµæœãªã—", search_placeholder: "éƒ½å¸‚åã‚’å…¥åŠ›...",
                temp: "æ°—æ¸©", feels_label: "ä½“æ„Ÿé«˜ä½"
            }
        };

        const STATE = {
            lang: localStorage.getItem('zenith_lang') || 'zh',
            activeId: 'gps',
            coords: { lat: 24.83, lon: 121.01 },
            model: localStorage.getItem('zenith_model') || 'auto',
            locations: JSON.parse(localStorage.getItem('zenith_locs')) || [
                { id: 'gps', name: 'current_loc', lat: null, lon: null },
                { id: 'zhubei', name: 'zhubei', lat: 24.83, lon: 121.01 },
                { id: 'taichung', name: 'taichung', lat: 24.14, lon: 120.67 },
                { id: 'taipei', name: 'taipei', lat: 25.03, lon: 121.56 },
                { id: 'osaka', name: 'osaka', lat: 34.69, lon: 135.50 }
            ],
            map: null,
            marker: null,
            charts: {}
        };

        // å®‰å…¨æ•¸å€¼è™•ç†
        const safe = (val, def = 0) => (val === null || val === undefined || isNaN(val)) ? def : val;

        // æŒ‡æ•¸é€€é¿é‡è©¦
        async function fetchRetry(url, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(res.status);
                    return await res.json();
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        // åœ°ç·£æ¨¡å‹åˆ¤å®š
        function getAutoModel(lat, lon) {
            // å°ç£å…¨å¢ƒ (é–å®š JMA)
            if (lat >= 21.8 && lat <= 25.5 && lon >= 119.5 && lon <= 122.5) return 'jma_seamless';
            
            // æ—¥æœ¬å…¨å¢ƒ (JMA)
            if (lat >= 24 && lat <= 46 && lon >= 122 && lon <= 150) return 'jma_seamless';
            
            // éŸ“åœ‹å…¨å¢ƒ (KMA)
            if (lat >= 33 && lat <= 43 && lon >= 124 && lon <= 132) return 'kma_deterministic';

            // æ­æ´² (ECMWF ç¯„åœä¼°ç®—)
            if (lat >= 35 && lat <= 72 && lon >= -25 && lon <= 45) return 'ecmwf_ifs04';

            // ç¾æ´² (GFS ç¯„åœä¼°ç®—)
            if (lat >= 7 && lat <= 72 && lon >= -170 && lon <= -50) return 'gfs_seamless';

            // è·é›¢åˆ¤å®šï¼šæ‰¾å‡ºæœ€è¿‘çš„æ°£è±¡ä¸­å¿ƒ
            const hubs = [
                { id: 'jma_seamless', lat: 35.6, lon: 139.7 }, // æ±äº¬
                { id: 'kma_deterministic', lat: 37.5, lon: 126.9 }, // é¦–çˆ¾
                { id: 'ecmwf_ifs04', lat: 51.4, lon: -1.3 }, // å€«æ•¦ (ECMWF)
                { id: 'gfs_seamless', lat: 38.9, lon: -77.0 } // è¯ç››é “
            ];
            
            let best = 'ecmwf_ifs04';
            let minDist = Infinity;
            hubs.forEach(h => {
                const d = Math.sqrt(Math.pow(lat - h.lat, 2) + Math.pow(lon - h.lon, 2));
                if (d < minDist) { minDist = d; best = h.id; }
            });
            return best;
        }

        function getWeatherEmoji(code) {
            const c = safe(code);
            if (c <= 1) return 'â˜€ï¸';
            if (c <= 3) return 'ğŸŒ¤ï¸';
            if (c <= 48) return 'ğŸŒ«ï¸';
            if (c <= 67) return 'ğŸŒ§ï¸';
            if (c <= 77) return 'â„ï¸';
            if (c <= 82) return 'ğŸŒ¦ï¸';
            return 'â›ˆï¸';
        }

        // åˆå§‹åŒ–èˆ‡åˆ‡æ›
        async function changeLang(l) {
            STATE.lang = l;
            localStorage.setItem('zenith_lang', l);
            
            // æ›´æ–° UI éœæ…‹æ–‡å­—
            const t = I18N[l];
            document.getElementById('ui-search-title').innerText = t.search_title;
            document.getElementById('search-input').placeholder = t.search_placeholder;
            document.getElementById('ui-cancel').innerText = t.cancel;
            document.getElementById('ui-feels').innerText = t.feels;
            document.getElementById('ui-rain-label').innerText = t.rain;
            document.getElementById('ui-wind-label').innerText = t.wind;
            document.getElementById('ui-yesterday').innerText = t.yesterday;
            document.getElementById('ui-today').innerText = t.today;
            document.getElementById('ui-hourly-title').innerHTML = `<span class="w-4 h-[2px] bg-blue-500"></span> ${t.hourly}`;
            document.getElementById('ui-8day-title').innerHTML = `<span class="w-4 h-[2px] bg-amber-500"></span> ${t.d8}`;
            document.getElementById('ui-14day-title').innerHTML = `<span class="w-4 h-[2px] bg-blue-500"></span> ${t.d14}`;
            
            // æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.btn-pill').forEach(b => b.classList.remove('btn-active'));
            document.getElementById('lang-' + l).classList.add('btn-active');

            renderLocationBar();
            refreshWeather();
        }

        function manualModel(m) {
            STATE.model = m;
            localStorage.setItem('zenith_model', m);
            refreshWeather();
        }

        async function refreshWeather() {
            const loader = document.getElementById('loader');
            loader.style.opacity = '1';
            loader.style.pointerEvents = 'auto';

            const { lat, lon } = STATE.coords;
            const modelToUse = STATE.model === 'auto' ? getAutoModel(lat, lon) : STATE.model;
            document.getElementById('final-model-badge').innerText = `ENGINE: ${modelToUse.toUpperCase()}`;

            // API åƒæ•¸çµ„åˆ
            const params = new URLSearchParams({
                latitude: lat,
                longitude: lon,
                hourly: 'temperature_2m,apparent_temperature,precipitation,weathercode',
                daily: 'weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,windspeed_10m_max',
                timezone: 'auto',
                past_days: 1,
                forecast_days: 14,
                models: modelToUse
            });

            try {
                const data = await fetchRetry(`https://api.open-meteo.com/v1/forecast?${params.toString()}`);
                
                // è™•ç†å¤šæ¨¡å‹è³‡æ–™çµæ§‹å·®ç•°
                const h = data.hourly[modelToUse] || data.hourly;
                const d = data.daily[modelToUse] || data.daily;

                renderMainInfo(h, d);
                renderVisuals(h, d);
                render14DayList(d);
                syncMap(lat, lon);
                resolveCityName(lat, lon);
            } catch (err) {
                console.error("Zenith Engine Error:", err);
            } finally {
                setTimeout(() => {
                    loader.style.opacity = '0';
                    loader.style.pointerEvents = 'none';
                }, 600);
            }
        }

        function renderMainInfo(h, d) {
            const now = new Date();
            const hIdx = Math.max(0, h.time.findIndex(t => new Date(t) > now) - 1);

            document.getElementById('main-temp').innerText = Math.round(safe(h.temperature_2m[hIdx]));
            document.getElementById('main-feels').innerText = Math.round(safe(h.apparent_temperature[hIdx]));
            document.getElementById('main-emoji').innerText = getWeatherEmoji(h.weathercode[hIdx]);
            document.getElementById('main-rain').innerText = safe(h.precipitation[hIdx]).toFixed(1);
            document.getElementById('main-wind').innerText = Math.round(safe(d.windspeed_10m_max[1]));
            document.getElementById('display-time').innerText = now.toLocaleString(STATE.lang === 'zh' ? 'zh-TW' : (STATE.lang === 'ja' ? 'ja-JP' : 'en-US'));

            // æ˜¨æ—¥
            document.getElementById('date-yes').innerText = d.time[0];
            document.getElementById('yes-hilo').innerText = `${Math.round(safe(d.temperature_2m_max[0]))} / ${Math.round(safe(d.temperature_2m_min[0]))}`;
            document.getElementById('yes-feels-hilo').innerText = `${Math.round(safe(d.apparent_temperature_max[0]))} / ${Math.round(safe(d.apparent_temperature_min[0]))}`;
            document.getElementById('yes-rain').innerText = safe(d.precipitation_sum[0]).toFixed(1);
            document.getElementById('yes-wind').innerText = Math.round(safe(d.windspeed_10m_max[0]));

            // ä»Šæ—¥
            document.getElementById('today-hilo').innerText = `${Math.round(safe(d.temperature_2m_max[1]))} / ${Math.round(safe(d.temperature_2m_min[1]))}`;
            document.getElementById('today-feels-hilo').innerText = `${Math.round(safe(d.apparent_temperature_max[1]))} / ${Math.round(safe(d.apparent_temperature_min[1]))}`;
            document.getElementById('today-emoji').innerText = getWeatherEmoji(d.weathercode[1]);
            document.getElementById('today-rain').innerText = safe(d.precipitation_sum[1]).toFixed(1);
            document.getElementById('today-wind').innerText = Math.round(safe(d.windspeed_10m_max[1]));

            // æ°£æº«è®ŠåŒ–
            const diff = safe(d.temperature_2m_max[1]) - safe(d.temperature_2m_max[0]);
            const diffTag = document.getElementById('temp-diff-tag');
            diffTag.className = `text-[10px] font-black px-2 py-0.5 rounded ${diff >= 0 ? 'bg-red-500/10 text-red-400' : 'bg-blue-500/10 text-blue-400'}`;
            diffTag.innerText = `${I18N[STATE.lang].diff_vs} ${diff >= 0 ? '+' : ''}${diff.toFixed(1)}Â°`;
        }

        function renderVisuals(h, d) {
            Chart.register(ChartDataLabels);
            const now = new Date();
            const start = Math.max(0, h.time.findIndex(t => new Date(t) > now) - 1);
            const end = start + 12;

            // 12å°æ™‚è¶¨å‹¢
            const hLabels = h.time.slice(start, end).map(t => new Date(t).getHours() + ":00");
            const hTemp = h.temperature_2m.slice(start, end);
            const hFeels = h.apparent_temperature.slice(start, end);
            const hRain = h.precipitation.slice(start, end);
            const hCodes = h.weathercode.slice(start, end);

            if (STATE.charts.hourly) STATE.charts.hourly.destroy();
            STATE.charts.hourly = new Chart(document.getElementById('hourly-chart'), {
                data: {
                    labels: hLabels,
                    datasets: [
                        { type: 'line', data: hTemp, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#fff', datalabels: { align: 'top', color: '#fff', font: { weight: 'bold' } } },
                        { type: 'line', data: hFeels, borderColor: 'rgba(59, 130, 246, 0.3)', borderWidth: 1, borderDash: [3, 3], tension: 0.4, pointRadius: 0, datalabels: { display: false } },
                        { type: 'bar', data: hRain, backgroundColor: 'rgba(59, 130, 246, 0.15)', yAxisID: 'yRain', datalabels: { align: 'top', color: '#60a5fa', formatter: v => v > 0 ? v + 'm' : '' } }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, 
                        tooltip: { enabled: true },
                        datalabels: { 
                            formatter: (v, ctx) => {
                                if (ctx.datasetIndex === 0) return getWeatherEmoji(hCodes[ctx.dataIndex]) + "\n" + Math.round(v) + "Â°";
                                return "";
                            },
                            font: { size: 10 }, textAlign: 'center'
                        }
                    },
                    scales: { y: { display: false, suggestedMin: Math.min(...hTemp) - 2 }, yRain: { display: false, max: 20 }, x: { grid: { display: false }, ticks: { color: '#475569' } } }
                }
            });

            // 8æ—¥è¶¨å‹¢
            const dLabels = d.time.slice(0, 8).map((t, i) => i === 0 ? I18N[STATE.lang].yesterday : t.slice(5).replace('-', '/'));
            const dMax = d.temperature_2m_max.slice(0, 8);
            const dMin = d.temperature_2m_min.slice(0, 8);
            const dRain = d.precipitation_sum.slice(0, 8);
            const dCodes = d.weathercode.slice(0, 8);

            if (STATE.charts.daily) STATE.charts.daily.destroy();
            STATE.charts.daily = new Chart(document.getElementById('daily-chart'), {
                data: {
                    labels: dLabels,
                    datasets: [
                        { type: 'line', data: dMax, borderColor: '#fbbf24', borderWidth: 4, tension: 0.4, datalabels: { align: 'top', color: '#fff', font: { weight: '900' } } },
                        { type: 'line', data: dMin, borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, datalabels: { align: 'bottom', color: '#60a5fa' } },
                        { type: 'bar', data: dRain, backgroundColor: 'rgba(59, 130, 246, 0.1)', yAxisID: 'yR', datalabels: { 
                            align: 'top', color: '#fff', offset: -20, font: { size: 14 }, 
                            formatter: (v, ctx) => getWeatherEmoji(dCodes[ctx.dataIndex]) + (v > 0 ? `\n${v.toFixed(1)}m` : '') 
                        } }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false, suggestedMin: Math.min(...dMin) - 5 }, yR: { display: false, max: 100 }, x: { grid: { display: false }, ticks: { color: '#64748b' } } }
                }
            });
        }

        function render14DayList(d) {
            const list = document.getElementById('forecast-list');
            list.innerHTML = '';
            for (let i = 1; i < d.time.length; i++) {
                const diff = safe(d.temperature_2m_max[i]) - safe(d.temperature_2m_max[i-1]);
                const card = document.createElement('div');
                card.className = "zenith-card p-5 flex flex-col sm:flex-row justify-between items-center gap-4 hover:bg-white/5 transition";
                
                const dateParts = d.time[i].split('-');
                const dateLabel = `${dateParts[1]}/${dateParts[2]}`;

                card.innerHTML = `
                    <div class="flex items-center gap-6 w-full sm:w-auto">
                        <div class="text-center min-w-[50px]">
                            <div class="text-[9px] font-black opacity-30">${dateLabel}</div>
                            <div class="text-3xl mt-1">${getWeatherEmoji(d.weathercode[i])}</div>
                        </div>
                        <div class="flex-grow">
                            <div class="text-xl font-black">${Math.round(safe(d.temperature_2m_max[i]))}Â° <span class="text-xs opacity-30 font-bold">${Math.round(safe(d.temperature_2m_min[i]))}Â°</span></div>
                            <div class="text-[9px] font-black ${diff >= 0 ? 'text-red-400' : 'text-blue-400'} uppercase mt-0.5">
                                ${diff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(diff).toFixed(1)}Â° ${I18N[STATE.lang].diff_vs}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-6 items-center w-full sm:w-auto justify-between border-t sm:border-t-0 border-white/5 pt-3 sm:pt-0">
                        <div class="text-right">
                            <div class="text-[8px] font-black opacity-20 uppercase tracking-tighter">${I18N[STATE.lang].feels_label}</div>
                            <div class="text-xs font-bold">${Math.round(safe(d.apparent_temperature_max[i]))}Â° / ${Math.round(safe(d.apparent_temperature_min[i]))}Â°</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[8px] font-black opacity-20 uppercase tracking-tighter">${I18N[STATE.lang].rain}</div>
                            <div class="text-xs font-bold text-blue-400">${safe(d.precipitation_sum[i]).toFixed(1)} mm</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[8px] font-black opacity-20 uppercase tracking-tighter">${I18N[STATE.lang].wind}</div>
                            <div class="text-xs font-bold text-emerald-500">${Math.round(safe(d.windspeed_10m_max[i]))} k</div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            }
        }

        // åœ°åœ–è™•ç†
        function syncMap(lat, lon) {
            if (!STATE.map) {
                STATE.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(STATE.map);
                STATE.marker = L.marker([lat, lon]).addTo(STATE.map);
            } else {
                STATE.map.setView([lat, lon], 9);
                STATE.marker.setLatLng([lat, lon]);
            }
            setTimeout(() => STATE.map.invalidateSize(), 300);
        }

        async function resolveCityName(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=${STATE.lang}`);
                const data = await res.json();
                const name = data.address.city || data.address.town || data.address.village || data.address.suburb || data.address.state || "Uncharted";
                document.getElementById('display-city').innerText = name.toUpperCase();
            } catch {
                document.getElementById('display-city').innerText = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
            }
        }

        // å°è¦½åˆ—èˆ‡æœå°‹
        function renderLocationBar() {
            const bar = document.getElementById('location-bar');
            bar.innerHTML = '';
            STATE.locations.forEach(loc => {
                const btn = document.createElement('button');
                btn.className = `btn-pill whitespace-nowrap ${STATE.activeId === loc.id ? 'btn-active' : 'bg-white/5 hover:bg-white/10'}`;
                btn.innerText = (I18N[STATE.lang][loc.name] || loc.name).toUpperCase();
                btn.onclick = () => selectLocation(loc.id);
                bar.appendChild(btn);
            });
        }

        function selectLocation(id) {
            STATE.activeId = id;
            const loc = STATE.locations.find(l => l.id === id);
            if (id === 'gps') {
                navigator.geolocation.getCurrentPosition(pos => {
                    STATE.coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    refreshWeather();
                    renderLocationBar();
                }, () => selectLocation('taipei'));
            } else {
                STATE.coords = { lat: loc.lat, lon: loc.lon };
                refreshWeather();
                renderLocationBar();
            }
        }

        function toggleSearch(show) {
            document.getElementById('search-modal').classList.toggle('hidden', !show);
            if (show) document.getElementById('search-input').focus();
        }

        async function performSearch() {
            const q = document.getElementById('search-input').value;
            if (!q) return;
            const results = document.getElementById('search-results');
            results.innerHTML = `<div class="text-center opacity-30 py-4">${I18N[STATE.lang].searching}</div>`;

            try {
                const data = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5&accept-language=${STATE.lang}`).then(r => r.json());
                results.innerHTML = '';
                if (data.length === 0) {
                    results.innerHTML = `<div class="text-center opacity-30 py-4">${I18N[STATE.lang].no_results}</div>`;
                    return;
                }
                data.forEach(item => {
                    const row = document.createElement('div');
                    row.className = "p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-blue-600/20 border border-white/5 transition";
                    const main = item.display_name.split(',')[0];
                    row.innerHTML = `<div class="font-black text-sm">${main}</div><div class="text-[10px] opacity-30 truncate">${item.display_name}</div>`;
                    row.onclick = () => {
                        const newLoc = { id: 'c'+Date.now(), name: main, lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
                        STATE.locations.push(newLoc);
                        localStorage.setItem('zenith_locs', JSON.stringify(STATE.locations));
                        toggleSearch(false);
                        selectLocation(newLoc.id);
                    };
                    results.appendChild(row);
                });
            } catch (e) { results.innerHTML = '<div class="text-red-400 text-center py-4">Search Error</div>'; }
        }

        window.onload = () => changeLang(STATE.lang);
    </script>
</body>
</html>
