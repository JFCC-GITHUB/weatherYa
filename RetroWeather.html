<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WeatherYa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-teal: #30B0C7;
            --rain-blue: #00B2FF;
        }

        body {
            background-color: #FFFFFF;
            color: #1C1C1E;
            font-family: "Inter", "Noto Sans TC", "Noto Sans JP", sans-serif;
            margin: 0;
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased;
        }

        /* Èö±ËóèÊªæÂãïÊ¢ù‰ΩÜ‰øùÊåÅÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #mini-map {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid #F2F2F7;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .stat-card {
            background: #F9F9FB;
            border-radius: 24px;
            padding: 16px;
            border: 1px solid #F2F2F7;
        }

        .btn-tab {
            padding: 10px 18px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 800;
            transition: all 0.2s;
            background: #F2F2F7;
            color: #8E8E93;
            white-space: nowrap;
        }

        .btn-tab.active {
            background: var(--ios-blue);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
        }

        .loader-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .chart-wrapper { 
            width: 100%; 
            overflow: hidden; /* Èò≤Ê≠¢Â∑¶Âè≥ÊªëÂãï */
        }
        
        .chart-inner {
            width: 100%;
            height: 240px;
            padding-top: 10px;
        }

        .deep-forecast-item {
            display: grid;
            grid-template-columns: 65px 45px 1fr 90px;
            align-items: center;
            padding: 18px 16px;
            background: #F9F9FB;
            border-radius: 20px;
            gap: 12px;
        }

        .temp-up { color: var(--ios-red); }
        .temp-down { color: var(--ios-blue); }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loader" class="loader-screen">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-slate-400 text-xs tracking-widest uppercase">WeatherYa Data Syncing</p>
    </div>

    <!-- Search Overlay -->
    <div id="search-modal" class="fixed inset-0 z-[5000] hidden bg-white p-6 pt-16">
        <div class="max-w-md mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="ui-search-title" class="text-2xl font-black">Âú∞ÈªûÊêúÂ∞ã</h2>
                <button onclick="toggleSearch(false)" class="text-slate-400 font-bold" id="ui-cancel">ÂèñÊ∂à</button>
            </div>
            <div class="flex gap-2 mb-6">
                <input type="text" id="search-input" class="flex-grow bg-slate-100 rounded-xl px-4 py-4 outline-none font-bold" placeholder="ÊêúÂ∞ãÂüéÂ∏Ç..." onkeypress="if(event.key === 'Enter') performSearch()">
                <button onclick="performSearch()" class="bg-blue-600 text-white px-6 rounded-xl font-black">Â∞ãÊâæ</button>
            </div>
            <div id="search-results" class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <main class="max-w-md mx-auto px-5 py-6 space-y-8">
        
        <!-- Header & Lang -->
        <header class="flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter text-blue-600">WeatherYa</h1>
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button onclick="setLang('zh')" id="btn-zh" class="px-4 py-1.5 rounded-lg text-xs font-black transition-all">ÁπÅ</button>
                <button onclick="setLang('ja')" id="btn-ja" class="px-4 py-1.5 rounded-lg text-xs font-black transition-all">Êó•</button>
                <button onclick="setLang('en')" id="btn-en" class="px-4 py-1.5 rounded-lg text-xs font-black transition-all">EN</button>
            </div>
        </header>

        <!-- Location Selector -->
        <nav id="location-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-1"></nav>

        <!-- Current Status & Mini Map -->
        <section class="flex justify-between items-center gap-4">
            <div class="flex-grow min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <span id="actual-model-badge" class="text-[9px] font-black bg-slate-800 text-white px-2 py-0.5 rounded uppercase">MODEL</span>
                    <select id="model-select" onchange="manualModelChange(this.value)" class="bg-slate-100 text-[9px] font-black px-1 py-0.5 rounded uppercase outline-none">
                        <option value="auto">Auto</option>
                        <option value="jma_seamless">JMA</option>
                        <option value="kma_gdps">KMA</option>
                        <option value="ecmwf_ifs025">ECMWF</option>
                        <option value="gfs_global">GFS</option>
                    </select>
                </div>
                <h2 id="city-name" class="text-3xl font-black text-slate-900 truncate tracking-tight mb-2">---</h2>
                <div class="flex items-baseline gap-1">
                    <span id="curr-temp" class="text-6xl font-black tracking-tighter">--</span>
                    <span class="text-xl font-black text-blue-500">¬∞C</span>
                </div>
                <div class="grid grid-cols-2 gap-y-2 mt-4 text-[11px] font-black text-slate-400 uppercase">
                    <div><span id="ui-lbl-wind">È¢®ÈÄü</span> <span id="curr-wind" class="text-slate-900">--</span> km/h</div>
                    <div><span id="ui-lbl-rain">ÈôçÈõ®</span> <span id="curr-rain" class="text-blue-600">--</span> mm</div>
                    <div class="col-span-2"><span id="ui-lbl-feels">È´îÊÑü</span> <span id="curr-feels" class="text-slate-900">--</span>¬∞C</div>
                </div>
            </div>
            <div id="mini-map"></div>
        </section>

        <!-- Past vs Future Cards -->
        <section class="grid grid-cols-2 gap-3">
            <!-- Yesterday -->
            <div class="stat-card">
                <div class="flex justify-between mb-3">
                    <span id="ui-lbl-yesterday" class="text-[10px] font-black text-slate-400 uppercase">Êò®Êó•ÂõûÈ°ß</span>
                    <span id="yest-emoji" class="text-lg">‚òÄÔ∏è</span>
                </div>
                <div class="text-xl font-black mb-1" id="yest-temp">-- / --¬∞</div>
                <div class="text-[10px] font-bold text-slate-400 mb-2"><span id="ui-lbl-feels-y">È´îÊÑü</span> <span id="yest-feels" class="text-slate-900">-- / --</span>¬∞</div>
                <div class="pt-2 border-t border-slate-200 text-[9px] font-black space-y-1">
                    <div class="flex justify-between">
                        <span class="text-blue-500"><span id="yest-rain">--</span>mm</span>
                        <span><span id="yest-wind">--</span>km/h</span>
                    </div>
                    <div id="yest-diff-txt" class="text-slate-300">---</div>
                </div>
            </div>
            <!-- Today -->
            <div class="stat-card bg-blue-600 text-white border-none shadow-lg shadow-blue-100">
                <div class="flex justify-between mb-3">
                    <span id="ui-lbl-today" class="text-[10px] font-black text-blue-200 uppercase">‰ªäÊó•È†êÂ†±</span>
                    <span id="today-emoji" class="text-lg">üå§Ô∏è</span>
                </div>
                <div class="text-xl font-black mb-1" id="today-temp">-- / --¬∞</div>
                <div id="today-diff-txt" class="text-[10px] font-black text-blue-100 mb-2">---</div>
                <div class="pt-2 border-t border-white/20 text-[9px] font-black space-y-1">
                    <div class="flex justify-between">
                        <span class="text-blue-100"><span id="today-rain">--</span>mm</span>
                        <span class="opacity-70"><span id="today-wind">--</span>km/h</span>
                    </div>
                    <div id="today-feels-txt">È´îÊÑü -- / --¬∞</div>
                </div>
            </div>
        </section>

        <!-- 12H Hourly Chart -->
        <section class="space-y-4">
            <h3 id="ui-lbl-12h" class="text-xs font-black text-slate-400 uppercase tracking-widest">12Â∞èÊôÇÊôÇÊÆµÈ†êÂ†±</h3>
            <div class="chart-wrapper">
                <div class="chart-inner">
                    <div id="hourly-icons" class="flex justify-around mb-2 px-2"></div>
                    <canvas id="chart-hourly"></canvas>
                </div>
            </div>
        </section>

        <!-- 8D Trend Chart -->
        <section class="space-y-4">
            <h3 id="ui-lbl-8d" class="text-xs font-black text-slate-400 uppercase tracking-widest">8Êó•Ê∞£Ê∫´Ë∂®Âã¢</h3>
            <div class="chart-wrapper">
                <div class="chart-inner">
                    <div id="daily-icons" class="flex justify-around mb-2 px-2"></div>
                    <canvas id="chart-daily"></canvas>
                </div>
            </div>
        </section>

        <!-- 14D Detailed List -->
        <section class="space-y-4 pb-10">
            <h3 id="ui-lbl-14d" class="text-xs font-black text-slate-400 uppercase tracking-widest">14Êó•Ê∑±Â∫¶È†êÂ†±</h3>
            <div id="list-14d" class="space-y-3"></div>
        </section>

    </main>

    <script>
        const I18N = {
            zh: {
                search_title: "ÊêúÂ∞ãÂú∞Èªû", cancel: "ÂèñÊ∂à", yesterday: "Êò®Êó•ÂõûÈ°ß", today: "‰ªäÊó•È†êÂ†±",
                h12: "12Â∞èÊôÇÊôÇÊÆµÈ†êÂ†±", d8: "8Êó•Ë∂®Âã¢È†êÂ†±", d14: "14Êó•Ê∑±Â∫¶È†êÂ†±", current_loc: "ÁõÆÂâç‰ΩçÁΩÆ",
                wind: "È¢®ÈÄü", rain: "ÈôçÈõ®", add: "Êñ∞Â¢û", diff_up: "È´òÊñºÊò®", diff_down: "‰ΩéÊñºÊò®", diff_same: "ÊåÅÂπ≥",
                feels: "È´îÊÑüÊ∫´Â∫¶", feels_short: "È´îÊÑü", diff: "Ê∞£Ê∫´ËÆäÂåñ",
                cities: { zhubei: "Á´πÂåó", taichung: "Âè∞‰∏≠", taipei: "Âè∞Âåó", osaka: "Â§ßÈò™" }
            },
            en: {
                search_title: "Search", cancel: "Cancel", yesterday: "Yesterday", today: "Today",
                h12: "12-Hour Forecast", d8: "8-Day Trend", d14: "14-Day Deep Forecast", current_loc: "Current",
                wind: "Wind", rain: "Rain", add: "Add", diff_up: "Higher", diff_down: "Lower", diff_same: "Same",
                feels: "Feels Like", feels_short: "Feels", diff: "Diff",
                cities: { zhubei: "Zhubei", taichung: "Taichung", taipei: "Taipei", osaka: "Osaka" }
            },
            ja: {
                search_title: "Ê§úÁ¥¢", cancel: "„Ç≠„É£„É≥„Çª„É´", yesterday: "Êò®Êó•ÂõûÈ°ß", today: "‰ªäÊó•‰∫àÂ†±",
                h12: "12ÊôÇÈñì‰∫àÂ†±", d8: "8Êó•ÈñìË∂®Âã¢", d14: "14Êó•ÈñìË©≥Á¥∞‰∫àÂ†±", current_loc: "ÁèæÂú®Âú∞",
                wind: "È¢®ÈÄü", rain: "ÈôçÊ∞¥", add: "ËøΩÂä†", diff_up: "Êò®Êó•„Çà„ÇäÈ´ò„ÅÑ", diff_down: "Êò®Êó•„Çà„Çä‰Ωé„ÅÑ", diff_same: "Êò®Êó•„Å®Âêå„Åò",
                feels: "‰ΩìÊÑüÊ∏©Â∫¶", feels_short: "‰ΩìÊÑü", diff: "Ê∞óÊ∏©Â§âÂåñ",
                cities: { zhubei: "Á´πÂåó", taichung: "Âè∞‰∏≠", taipei: "Âè∞Âåó", osaka: "Â§ßÈò™" }
            }
        };

        const STATE = {
            lang: localStorage.getItem('wy_lang') || 'zh',
            activeId: 'gps',
            model: localStorage.getItem('wy_model') || 'auto',
            actualModel: '',
            coords: { lat: 24.83, lon: 121.01 },
            locations: JSON.parse(localStorage.getItem('wy_locs_v2')) || [
                { id: 'gps', name: 'current_loc', lat: null, lon: null },
                { id: 'zhubei', name: 'cities.zhubei', lat: 24.8388, lon: 121.0043 },
                { id: 'taichung', name: 'cities.taichung', lat: 24.1477, lon: 120.6736 },
                { id: 'taipei', name: 'cities.taipei', lat: 25.0330, lon: 121.5654 },
                { id: 'osaka', name: 'cities.osaka', lat: 34.6937, lon: 135.5023 }
            ],
            charts: {},
            map: null,
            marker: null
        };

        Chart.register(ChartDataLabels);

        function t(key) {
            const keys = key.split('.');
            let val = I18N[STATE.lang];
            keys.forEach(k => val = val ? val[k] : key);
            return val || key;
        }

        function getEmoji(code) {
            if (code <= 1) return '‚òÄÔ∏è';
            if (code <= 3) return 'üå§Ô∏è';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return '‚ùÑÔ∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return '‚òÅÔ∏è';
        }

        // Á≤æÁ¢∫Âú∞Á∑£Ê®°ÂûãÂà§ÂÆö
        function determineModel(lat, lon) {
            if (STATE.model !== 'auto') return STATE.model;
            
            // Âè∞ÁÅ£ÂÖ®Â¢É (JMA ÂÑ™ÂÖà)
            if (lat >= 21.8 && lat <= 25.5 && lon >= 119.5 && lon <= 122.5) return 'jma_seamless';
            // Êó•Êú¨ÂÖ®Â¢É
            if (lat >= 24 && lat <= 46 && lon >= 122 && lon <= 150) return 'jma_seamless';
            // ÈüìÂúãÂÖ®Â¢É
            if (lat >= 33 && lat <= 39 && lon >= 124 && lon <= 131) return 'kma_gdps';
            // Ê≠êÊ¥≤ÂÖ®Â¢É (Âª£Áæ©ÁØÑÂúç)
            if (lat >= 35 && lat <= 72 && lon >= -15 && lon <= 35) return 'ecmwf_ifs025';
            // ÁæéÊ¥≤ÂÖ®Â¢É
            if (lat >= 24 && lat <= 72 && lon >= -170 && lon <= -52) return 'gfs_global';

            // ÂÖ∂‰ªñÂú∞ÈªûÔºöË®àÁÆóÊ≠êÂπæÈáåÂæóË∑ùÈõ¢ÈÅ∏ÊúÄËøë
            const centers = [
                { id: 'jma_seamless', lat: 35.6, lon: 139.7 }, 
                { id: 'kma_gdps', lat: 37.5, lon: 126.9 },
                { id: 'ecmwf_ifs025', lat: 48.8, lon: 2.3 }, 
                { id: 'gfs_global', lat: 38.9, lon: -77.0 }
            ];
            let minD = Infinity, target = 'ecmwf_ifs025';
            centers.forEach(c => {
                const d = Math.sqrt(Math.pow(lat - c.lat, 2) + Math.pow(lon - c.lon, 2));
                if (d < minD) { minD = d; target = c.id; }
            });
            return target;
        }

        // API ÈáçË©¶Ê©üÂà∂
        async function fetchWithRetry(url, limit = 5) {
            let delay = 1000;
            for (let i = 0; i < limit; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('API Error');
                    return await response.json();
                } catch (err) {
                    if (i === limit - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        function updateUIStrings() {
            document.getElementById('ui-search-title').innerText = t('search_title');
            document.getElementById('ui-cancel').innerText = t('cancel');
            document.getElementById('ui-lbl-wind').innerText = t('wind');
            document.getElementById('ui-lbl-rain').innerText = t('rain');
            document.getElementById('ui-lbl-feels').innerText = t('feels_short');
            document.getElementById('ui-lbl-yesterday').innerText = t('yesterday');
            document.getElementById('ui-lbl-today').innerText = t('today');
            document.getElementById('ui-lbl-feels-y').innerText = t('feels_short');
            document.getElementById('ui-lbl-12h').innerText = t('h12');
            document.getElementById('ui-lbl-8d').innerText = t('d8');
            document.getElementById('ui-lbl-14d').innerText = t('d14');
            document.getElementById('model-select').value = STATE.model;

            ['zh', 'ja', 'en'].forEach(l => {
                const b = document.getElementById(`btn-${l}`);
                if(b) b.className = `px-4 py-1.5 rounded-lg text-xs font-black transition-all ${STATE.lang === l ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`;
            });
        }

        async function refresh() {
            const { lat, lon } = STATE.coords;
            const model = determineModel(lat, lon);
            STATE.actualModel = model;
            document.getElementById('actual-model-badge').innerText = model.split('_')[0].toUpperCase();

            // Â§öÊ®°ÂûãË≥áÊñôÊì∑Âèñ (Ê•µËá¥Êï∏ÊìöÂÆπÈåØ)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,windspeed_10m_max&timezone=auto&past_days=2&forecast_days=14&models=${model}`;

            try {
                const raw = await fetchWithRetry(url);
                // Â∞çÊáâ Open-Meteo Â§öÊ®°ÂûãÂõûÂÇ≥Ê¨Ñ‰Ωç
                const h = raw.hourly || raw[`hourly_${model}`] || {};
                const d = raw.daily || raw[`daily_${model}`] || {};
                
                const nowIdx = 48 + new Date().getHours(); 

                // Âç≥ÊôÇÊï∏Êìö
                document.getElementById('curr-temp').innerText = Math.round(h.temperature_2m?.[nowIdx] ?? 0);
                document.getElementById('curr-feels').innerText = Math.round(h.apparent_temperature?.[nowIdx] ?? 0);
                document.getElementById('curr-wind').innerText = Math.round(h.windspeed_10m?.[nowIdx] ?? 0);
                document.getElementById('curr-rain').innerText = (h.precipitation?.[nowIdx] ?? 0).toFixed(1);

                // Êò®Êó•Êï∏Êìö (Á¥¢Âºï 1 ÊòØÊò®Â§©Ôºå0 ÊòØÂâçÂ§©Ôºå2 ÊòØ‰ªäÂ§©)
                document.getElementById('yest-emoji').innerText = getEmoji(d.weathercode?.[1]);
                document.getElementById('yest-temp').innerText = `${Math.round(d.temperature_2m_max?.[1] ?? 0)}¬∞ / ${Math.round(d.temperature_2m_min?.[1] ?? 0)}¬∞`;
                document.getElementById('yest-feels').innerText = `${Math.round(d.apparent_temperature_max?.[1] ?? 0)} / ${Math.round(d.apparent_temperature_min?.[1] ?? 0)}`;
                document.getElementById('yest-rain').innerText = (d.precipitation_sum?.[1] ?? 0).toFixed(1);
                document.getElementById('yest-wind').innerText = Math.round(d.windspeed_10m_max?.[1] ?? 0);
                
                const yDiff = (d.temperature_2m_max[1] - d.temperature_2m_max[0]).toFixed(1);
                document.getElementById('yest-diff-txt').innerText = `${yDiff > 0 ? '+' : ''}${yDiff}¬∞C VS DAY BEFORE`;

                // ‰ªäÊó•Êï∏Êìö (Á¥¢Âºï 2)
                const tMax = d.temperature_2m_max[2];
                const yMax = d.temperature_2m_max[1];
                const diff = (tMax - yMax).toFixed(1);
                document.getElementById('today-emoji').innerText = getEmoji(d.weathercode[2]);
                document.getElementById('today-temp').innerText = `${Math.round(tMax)}¬∞ / ${Math.round(d.temperature_2m_min[2])}¬∞`;
                document.getElementById('today-feels-txt').innerText = `È´îÊÑü ${Math.round(d.apparent_temperature_max[2])}¬∞ / ${Math.round(d.apparent_temperature_min[2])}¬∞`;
                document.getElementById('today-rain').innerText = (d.precipitation_sum[2] ?? 0).toFixed(1);
                document.getElementById('today-wind').innerText = Math.round(d.windspeed_10m_max[2] ?? 0);
                
                let diffHtml = diff > 0 ? `<span class="text-white opacity-80">‚Üë${diff}¬∞</span> ${t('diff_up')}` : (diff < 0 ? `<span class="text-white opacity-80">‚Üì${Math.abs(diff)}¬∞</span> ${t('diff_down')}` : t('diff_same'));
                document.getElementById('today-diff-txt').innerHTML = diffHtml;

                updateMap(lat, lon);
                renderHourlyChart(h, nowIdx);
                renderDailyChart(d);
                render14DayList(d);
                reverseGeocode(lat, lon);

            } catch (err) {
                console.error("API Fetch Fail:", err);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderHourlyChart(h, start) {
            const labels = [], temps = [], feels = [], rains = [];
            const icons = document.getElementById('hourly-icons');
            icons.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                const idx = start + i;
                if(!h.time?.[idx]) break;
                labels.push(new Date(h.time[idx]).getHours() + ":00");
                temps.push(h.temperature_2m[idx]);
                feels.push(h.apparent_temperature[idx]);
                rains.push(h.precipitation?.[idx] ?? 0);
                
                const span = document.createElement('span');
                span.className = "text-lg";
                span.innerText = getEmoji(h.weathercode[idx]);
                icons.appendChild(span);
            }

            if(STATE.charts.h) STATE.charts.h.destroy();
            STATE.charts.h = new Chart(document.getElementById('chart-hourly'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Temp', data: temps, borderColor: '#007AFF', borderWidth: 3, tension: 0.4, yAxisID: 'y', pointRadius: 0 },
                        { label: 'Feels', data: feels, borderColor: '#FF9500', borderWidth: 2, borderDash: [4, 2], tension: 0.4, yAxisID: 'y', pointRadius: 0 },
                        { label: 'Rain', data: rains, type: 'bar', backgroundColor: '#00B2FF', yAxisID: 'y1', borderRadius: 4, datalabels: { display: true } }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            align: 'top', font: { size: 9, weight: '900' }, color: '#1C1C1E', offset: 4,
                            formatter: (v, ctx) => {
                                if (ctx.dataset.type === 'bar') return v > 0 ? v.toFixed(1) : '';
                                return Math.round(v) + '¬∞';
                            }
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '40%' }, 
                        y1: { display: false, position: 'right', max: Math.max(...rains, 2) * 4 }, 
                        x: { grid: { display: false }, ticks: { font: { weight: '700', size: 10 }, color: '#8E8E93' }}
                    }
                }
            });
        }

        function renderDailyChart(d) {
            const labels = [], maxs = [], mins = [], rains = [];
            const icons = document.getElementById('daily-icons');
            icons.innerHTML = '';

            // Ââç‰∏ÄÊó• (1) + Êú™‰æÜ‰∏ÉÊó• (2-8)
            for (let i = 1; i < 9; i++) {
                if(!d.time?.[i]) break;
                const date = new Date(d.time[i]);
                labels.push((date.getMonth() + 1) + "/" + date.getDate());
                maxs.push(d.temperature_2m_max[i]);
                mins.push(d.temperature_2m_min[i]);
                rains.push(d.precipitation_sum?.[i] ?? 0);

                const span = document.createElement('span');
                span.className = "text-lg";
                span.innerText = getEmoji(d.weathercode[i]);
                icons.appendChild(span);
            }

            if(STATE.charts.d) STATE.charts.d.destroy();
            STATE.charts.d = new Chart(document.getElementById('chart-daily'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Max', data: maxs, borderColor: '#FF3B30', borderWidth: 3, tension: 0.4, pointRadius: 4, pointBackgroundColor: 'white' },
                        { label: 'Min', data: mins, borderColor: '#007AFF', borderWidth: 3, tension: 0.4, pointRadius: 4, pointBackgroundColor: 'white' },
                        { label: 'Rain', data: rains, type: 'bar', backgroundColor: '#00B2FF', yAxisID: 'y1', borderRadius: 4, datalabels: { display: true } }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20 } },
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            align: (ctx) => ctx.dataset.label === 'Max' ? 'top' : (ctx.dataset.label === 'Min' ? 'bottom' : 'top'), 
                            font: { size: 9, weight: '900' }, color: '#1C1C1E', offset: 6,
                            formatter: (v, ctx) => {
                                if (ctx.dataset.type === 'bar') return v > 0 ? v.toFixed(1) : '';
                                return Math.round(v) + '¬∞';
                            }
                        }
                    },
                    scales: { 
                        y: { display: false, grace: '40%' }, 
                        y1: { display: false, position: 'right', max: Math.max(...rains, 5) * 4 }, 
                        x: { grid: { display: false }, ticks: { font: { weight: '700', size: 10 }, color: '#8E8E93' }}
                    }
                }
            });
        }

        function render14DayList(d) {
            const container = document.getElementById('list-14d');
            container.innerHTML = '';
            for (let i = 2; i < 16; i++) {
                if(!d.time?.[i]) break;
                const date = new Date(d.time[i]);
                const langCode = STATE.lang==='zh'?'zh-TW':(STATE.lang==='ja'?'ja-JP':'en-US');
                const dayName = date.toLocaleDateString(langCode, { weekday: 'short' });
                const diff = (d.temperature_2m_max[i] - d.temperature_2m_max[i-1]).toFixed(1);
                
                const item = document.createElement('div');
                item.className = "deep-forecast-item active:scale-[0.98] transition-all";
                item.innerHTML = `
                    <div>
                        <div class="text-[9px] font-black text-slate-400 uppercase leading-none mb-1">${date.getMonth()+1}/${date.getDate()}</div>
                        <div class="text-sm font-black text-slate-800">${dayName}</div>
                    </div>
                    <div class="text-2xl">${getEmoji(d.weathercode[i])}</div>
                    <div class="flex-grow">
                        <div class="text-base font-black">${Math.round(d.temperature_2m_max[i])}¬∞ / ${Math.round(d.temperature_2m_min[i])}¬∞</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${t('feels')} ${Math.round(d.apparent_temperature_max[i])}¬∞C</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] font-black text-blue-600">${(d.precipitation_sum?.[i]??0).toFixed(1)} mm</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${Math.round(d.windspeed_10m_max?.[i]??0)} km/h</div>
                        <div class="text-[9px] font-black mt-0.5">${diff > 0 ? `<span class="temp-up">‚Üë${diff}¬∞</span>` : (diff < 0 ? `<span class="temp-down">‚Üì${Math.abs(diff)}¬∞</span>` : t('diff_same'))}</div>
                    </div>
                `;
                container.appendChild(item);
            }
        }

        function updateMap(lat, lon) {
            if (!STATE.map) {
                STATE.map = L.map('mini-map', { zoomControl: false, attributionControl: false, touchZoom: false, scrollWheelZoom: false, dragging: false }).setView([lat, lon], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(STATE.map);
                STATE.marker = L.marker([lat, lon]).addTo(STATE.map);
            } else {
                STATE.map.setView([lat, lon], 9);
                STATE.marker.setLatLng([lat, lon]);
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                const lang = STATE.lang === 'zh' ? 'zh-TW' : STATE.lang;
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&accept-language=${lang}`);
                const data = await res.json();
                document.getElementById('city-name').innerText = data.address.city || data.address.town || data.address.village || data.address.state || "Apex Point";
            } catch (e) {
                document.getElementById('city-name').innerText = "Location Synced";
            }
        }

        function renderLocationBar() {
            const bar = document.getElementById('location-bar');
            bar.innerHTML = '';
            STATE.locations.forEach(loc => {
                const btn = document.createElement('button');
                btn.className = `btn-tab ${STATE.activeId === loc.id ? 'active' : ''}`;
                btn.innerText = t(loc.name);
                btn.onclick = () => switchLocation(loc.id);
                bar.appendChild(btn);
            });
            const add = document.createElement('button');
            add.className = "btn-tab border-2 border-dashed border-slate-200 bg-transparent flex items-center justify-center min-w-[50px]";
            add.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>`;
            add.onclick = () => toggleSearch(true);
            bar.appendChild(add);
        }

        function switchLocation(id) {
            STATE.activeId = id;
            document.getElementById('loader').style.display = 'flex';
            const loc = STATE.locations.find(l => l.id === id);
            if(id === 'gps') {
                navigator.geolocation.getCurrentPosition(p => {
                    STATE.coords = { lat: p.coords.latitude, lon: p.coords.longitude };
                    refresh();
                }, () => {
                    STATE.coords = { lat: 24.83, lon: 121.01 }; 
                    refresh();
                }, { timeout: 6000 });
            } else {
                STATE.coords = { lat: loc.lat, lon: loc.lon };
                refresh();
            }
            renderLocationBar();
        }

        function setLang(l) {
            STATE.lang = l;
            localStorage.setItem('wy_lang', l);
            updateUIStrings();
            renderLocationBar();
            refresh();
        }

        function manualModelChange(m) {
            STATE.model = m;
            localStorage.setItem('wy_model', m);
            switchLocation(STATE.activeId);
        }

        function toggleSearch(s) { document.getElementById('search-modal').classList.toggle('hidden', !s); }

        async function performSearch() {
            const q = document.getElementById('search-input').value.trim();
            if(!q) return;
            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="text-center py-20 font-black text-slate-200 text-xs uppercase animate-pulse">Syncing Database...</div>';
            try {
                const lang = STATE.lang === 'zh' ? 'zh-TW' : STATE.lang;
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=${lang}`);
                const data = await res.json();
                container.innerHTML = '';
                if(!data.results) { container.innerHTML = '<div class="text-center py-20 font-black text-slate-300 text-xs uppercase">No Results</div>'; return; }
                data.results.forEach(r => {
                    const d = document.createElement('div');
                    d.className = "bg-slate-50 p-5 rounded-2xl flex justify-between items-center active:scale-95 transition-all border border-slate-100";
                    d.innerHTML = `
                        <div class="min-w-0 flex-grow">
                            <div class="font-black text-slate-900 truncate">${r.name}</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase truncate">${r.admin1||''}, ${r.country}</div>
                        </div>
                        <div class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-xs uppercase">${t('add')}</div>
                    `;
                    d.onclick = () => {
                        const newLoc = { id: 'loc_'+Date.now(), name: r.name, lat: r.latitude, lon: r.longitude };
                        STATE.locations.push(newLoc);
                        localStorage.setItem('wy_locs_v2', JSON.stringify(STATE.locations));
                        toggleSearch(false);
                        switchLocation(newLoc.id);
                    };
                    container.appendChild(d);
                });
            } catch(e) { container.innerHTML = 'Search Error.'; }
        }

        window.onload = () => {
            updateUIStrings();
            switchLocation(STATE.activeId);
        };
    </script>
</body>
</html>
