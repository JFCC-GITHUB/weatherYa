<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RetroWeather Pro</title>
    
    <!-- PWA / Mobile Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RetroWeather">
    <link rel="apple-touch-icon" href="icon-512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    
    <style>
        body {
            background: linear-gradient(180deg, #020617 0%, #0f172a 100%);
            min-height: 100vh;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:active { transform: scale(0.97); background: rgba(255, 255, 255, 0.1); }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 100;
        }
        .modal-content {
            background: #0f172a;
            width: 100%;
            max-width: 500px;
            border-top-left-radius: 32px;
            border-top-right-radius: 32px;
            padding: 2.5rem 2rem;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: #020617;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        select option { color: #111827; }
        .indicator-bar { height: 4px; border-radius: 4px; background: rgba(255,255,255,0.05); overflow: hidden; }
        .indicator-progress { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        #forecastList::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="p-4 pb-16">
    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-xs tracking-widest text-blue-400">æ­£åœ¨ç²å–å¯¦æ™‚è§€æ¸¬æ•¸æ“š...</p>
        </div>
    </div>

    <!-- è©³ç´°æ•¸æ“šå½ˆçª— -->
    <div id="infoModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-8"></div>
            <div id="modalIcon" class="text-5xl mb-6 text-center">ğŸ“Š</div>
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-center">æ•¸æ“šè©³æƒ…</h3>
            <div id="modalBody" class="text-slate-300 text-sm leading-relaxed mb-8 bg-white/5 p-6 rounded-3xl"></div>
            <button class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold active:scale-95 transition-transform" onclick="closeModal()">ç¢ºèª</button>
        </div>
    </div>

    <!-- Header -->
    <header class="mb-8 pt-8 px-2 flex justify-between items-start">
        <div class="flex-1">
            <select id="locationSelect" class="bg-transparent border-none text-2xl font-bold focus:outline-none pr-8 cursor-pointer outline-none text-white w-full max-w-[280px]">
                <option value="gps">ğŸ“ è‡ªå‹•åµæ¸¬ (GPS)</option>
                <option value="Sanchong">æ–°åŒ—ä¸‰é‡</option>
                <option value="Zhubei">ç«¹åŒ—</option>
                <option value="Dali">å°ä¸­å¤§é‡Œ</option>
                <option value="Osaka">å¤§é˜ª (Osaka)</option>
                <option value="Kobe">ç¥æˆ¶ (Kobe)</option>
            </select>
            <p id="currentDesc" class="opacity-50 text-xs mt-2 tracking-widest uppercase font-medium">ç³»çµ±åŒæ­¥ä¸­...</p>
        </div>
        <div class="text-right">
            <div id="mainTemp" class="text-6xl font-extralight tracking-tighter">--Â°</div>
            <p id="mainRain" class="text-[10px] font-black text-blue-400 mt-2 uppercase tracking-widest">RAIN --%</p>
        </div>
    </header>

    <!-- ç¶œåˆæŒ‡æ¨™ï¼šæ¿•åº¦ã€é¢¨é€Ÿã€UVã€é«”æ„Ÿ -->
    <section class="glass-card p-6 mb-4" onclick="showDetail('combined')">
        <h2 class="text-[10px] font-bold uppercase tracking-[0.3em] opacity-40 mb-6">ç’°å¢ƒæ·±åº¦æŒ‡æ¨™</h2>
        <div class="grid grid-cols-2 gap-y-6 gap-x-8">
            <div>
                <div class="flex justify-between items-center mb-1">
                    <p class="text-[10px] opacity-60">é«”æ„Ÿæº«åº¦</p>
                    <p id="todayApparent" class="text-lg font-bold">--Â°</p>
                </div>
                <div class="indicator-bar"><div id="apparentBar" class="indicator-progress bg-orange-500" style="width: 0%"></div></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <p class="text-[10px] opacity-60">ç´«å¤–ç·šæŒ‡æ•¸</p>
                    <p id="todayUV" class="text-lg font-bold">--</p>
                </div>
                <div class="indicator-bar"><div id="uvBar" class="indicator-progress bg-yellow-400" style="width: 0%"></div></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <p class="text-[10px] opacity-60">ç›¸å°æ¿•åº¦</p>
                    <p id="todayHumid" class="text-lg font-bold">--%</p>
                </div>
                <div class="indicator-bar"><div id="humidBar" class="indicator-progress bg-blue-400" style="width: 0%"></div></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <p class="text-[10px] opacity-60">æœ€å¤§é¢¨é€Ÿ</p>
                    <p id="todayWind" class="text-lg font-bold">-- km/h</p>
                </div>
                <div class="indicator-bar"><div id="windBar" class="indicator-progress bg-emerald-400" style="width: 0%"></div></div>
            </div>
        </div>
    </section>

    <!-- æ°£æº«èˆ‡é™é›¨è¶¨å‹¢åœ– -->
    <section class="glass-card p-6 mb-4" onclick="showDetail('chart')">
        <h2 class="text-[10px] font-bold uppercase tracking-[0.3em] mb-6 opacity-40">8 æ—¥å‹•æ…‹å·®è·åˆ†æ</h2>
        <div class="h-[240px] w-full"><canvas id="weatherChart"></canvas></div>
    </section>

    <!-- 14 æ—¥è©³ç›¡åˆ—è¡¨ -->
    <section class="glass-card p-6">
        <h2 class="text-[10px] font-bold uppercase tracking-[0.3em] mb-6 opacity-40">æœªä¾† 14 æ—¥è¶¨å‹¢æ¸…å–®</h2>
        <div id="forecastList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
    </section>

    <footer class="mt-8 text-center text-[9px] opacity-30 leading-relaxed pb-12 tracking-widest uppercase">
        æ•¸æ“šå‡ºè™•ï¼šOpen-Meteo API / OSM Nominatim<br>
        æ¶æ§‹ï¼šPWA Standalone Engine<br>
        è¦–è¦ºï¼šDynamic Scaled Charting
    </footer>

    <script>
        // PWA Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW è¨»å†Šå¤±æ•—:', err));
            });
        }

        Chart.register(ChartDataLabels);
        let weatherChart;
        let unifiedData = [];

        const locations = {
            Sanchong: { lat: 25.06, lon: 121.49, bg: '#0f172a', name: 'æ–°åŒ—ä¸‰é‡' },
            Zhubei: { lat: 24.83, lon: 121.01, bg: '#0f172a', name: 'ç«¹åŒ—' },
            Dali: { lat: 24.10, lon: 120.68, bg: '#0f172a', name: 'å°ä¸­å¤§é‡Œ' },
            Osaka: { lat: 34.69, lon: 135.50, bg: '#0f172a', name: 'å¤§é˜ª' },
            Kobe: { lat: 34.69, lon: 135.19, bg: '#0f172a', name: 'ç¥æˆ¶' }
        };

        async function handleLocationChange(val) {
            document.getElementById('loader').style.display = 'flex';
            if (val === 'gps') {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        async (pos) => fetchWeather(pos.coords.latitude, pos.coords.longitude, '#0f172a', "è‡ªå‹•åµæ¸¬"),
                        () => fetchWeather(25.06, 121.49, '#0f172a', 'æ–°åŒ—ä¸‰é‡'),
                        { timeout: 8000 }
                    );
                }
            } else {
                const loc = locations[val];
                fetchWeather(loc.lat, loc.lon, loc.bg, loc.name);
            }
        }

        async function fetchWeather(lat, lon, bg, name) {
            try {
                let displayName = name;
                if (name === "è‡ªå‹•åµæ¸¬") {
                    const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12`, { headers: { 'Accept-Language': 'zh-TW' }});
                    const gData = await geo.json();
                    displayName = gData.address.city || gData.address.town || gData.address.district || name;
                    document.querySelector('option[value="gps"]').innerText = `ğŸ“ ${displayName}`;
                }

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,uv_index_max,precipitation_probability_max,windspeed_10m_max,relative_humidity_2m_max&timezone=auto&past_days=1&forecast_days=14`;
                const resp = await fetch(url);
                const data = await resp.json();
                
                unifiedData = data.daily.time.map((t, i) => ({
                    date: t,
                    displayDate: formatFullDate(t),
                    high: Math.round(data.daily.temperature_2m_max[i]),
                    low: Math.round(data.daily.temperature_2m_min[i]),
                    apparent: Math.round(data.daily.apparent_temperature_max[i]),
                    uv: data.daily.uv_index_max[i],
                    rainProb: data.daily.precipitation_probability_max[i],
                    wind: data.daily.windspeed_10m_max[i],
                    humid: data.daily.relative_humidity_2m_max[i]
                }));

                updateUI(displayName);
            } catch (e) { console.error(e); } finally { document.getElementById('loader').style.display = 'none'; }
        }

        function formatFullDate(dateStr) {
            const date = new Date(dateStr);
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            return `${date.getMonth() + 1}/${date.getDate()} ${weekdays[date.getDay()]}`;
        }

        function updateUI(name) {
            const today = unifiedData[1];
            document.getElementById('mainTemp').innerText = today.high + 'Â°';
            document.getElementById('mainRain').innerText = `RAIN ${today.rainProb}%`;
            document.getElementById('todayUV').innerText = today.uv.toFixed(1);
            document.getElementById('todayApparent').innerText = today.apparent + 'Â°';
            document.getElementById('todayHumid').innerText = today.humid + '%';
            document.getElementById('todayWind').innerText = Math.round(today.wind) + ' km/h';
            document.getElementById('currentDesc').innerText = `${name} Â· ${today.displayDate}`;
            
            document.getElementById('uvBar').style.width = (Math.min(today.uv / 12, 1) * 100) + '%';
            document.getElementById('apparentBar').style.width = (Math.min(today.apparent / 45, 1) * 100) + '%';
            document.getElementById('humidBar').style.width = today.humid + '%';
            document.getElementById('windBar').style.width = (Math.min(today.wind / 50, 1) * 100) + '%';

            renderChart(unifiedData.slice(0, 8));
            renderList(unifiedData.slice(1));
        }

        function renderChart(data) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if (weatherChart) weatherChart.destroy();
            
            const allTemps = [...data.map(d => d.high), ...data.map(d => d.low)];
            const minTemp = Math.min(...allTemps) - 2;
            const maxTemp = Math.max(...allTemps) + 4;

            weatherChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map((d, i) => i === 0 ? 'æ˜¨æ—¥' : d.displayDate.split(' ')[0]),
                    datasets: [
                        {
                            label: 'é«˜æº«', type: 'line', data: data.map(d => d.high),
                            borderColor: '#fbbf24', borderWidth: 4, tension: 0.4, pointRadius: 4,
                            pointBackgroundColor: '#fbbf24', yAxisID: 'yTemp',
                            datalabels: { align: 'top', color: '#fbbf24', font: { weight: 'bold', size: 12 }, formatter: v => v + 'Â°' }
                        },
                        {
                            label: 'ä½æº«', type: 'line', data: data.map(d => d.low),
                            borderColor: '#38bdf8', borderWidth: 4, tension: 0.4, pointRadius: 4,
                            pointBackgroundColor: '#38bdf8', yAxisID: 'yTemp',
                            datalabels: { align: 'bottom', color: '#38bdf8', font: { weight: 'bold', size: 12 }, formatter: v => v + 'Â°' }
                        },
                        {
                            label: 'é™é›¨', data: data.map(d => d.rainProb),
                            backgroundColor: 'rgba(56, 189, 248, 0.12)', borderRadius: 10, yAxisID: 'yRain',
                            datalabels: { display: false }
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true } },
                    scales: {
                        yTemp: { display: false, min: minTemp, max: maxTemp },
                        yRain: { display: false, min: 0, max: 100 },
                        x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 11 } } }
                    }
                }
            });
        }

        function renderList(data) {
            const list = document.getElementById('forecastList');
            list.innerHTML = '';
            data.forEach((d, i) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 border-b border-white/5 last:border-0 hover:bg-white/5 rounded-xl px-2 transition-all';
                row.onclick = (e) => { e.stopPropagation(); showDetail('day', i); };
                let icon = d.rainProb > 50 ? 'ğŸŒ§ï¸' : (d.rainProb > 20 ? 'â›…' : 'â˜€ï¸');
                row.innerHTML = `
                    <div class="w-24">
                        <p class="text-xs font-bold">${i === 0 ? 'ä»Šæ—¥' : d.displayDate.split(' ')[0]}</p>
                        <p class="text-[9px] opacity-40 uppercase">${d.displayDate.split(' ')[1]}</p>
                    </div>
                    <span class="text-2xl">${icon}</span>
                    <div class="w-20 text-right">
                        <p class="text-blue-400 font-black text-xs">${d.rainProb}%</p>
                        <p class="text-[8px] opacity-30 font-bold uppercase">Rain</p>
                    </div>
                    <div class="flex items-center justify-end w-24">
                        <span class="font-bold text-base w-8 text-right">${d.high}Â°</span>
                        <span class="opacity-20 text-xs w-10 text-right ml-2">${d.low}Â°</span>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        function showDetail(type, index = 0) {
            const today = unifiedData[1];
            const modal = document.getElementById('infoModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            if (type === 'combined') {
                title.innerText = "æ·±åº¦ç’°å¢ƒåˆ†æ";
                body.innerHTML = `
                    <div class="space-y-4">
                        <p><b>æ¿•åº¦å½±éŸ¿ï¼š</b> ç•¶å‰æ¿•åº¦ç‚º ${today.humid}%ã€‚é«˜æ¿•åº¦æœƒé˜»ç¤™çš®è†šæ’æ±—ï¼Œä½¿é«”æ„Ÿæº«åº¦é¡¯è‘—é«˜æ–¼é æœŸã€‚</p>
                        <p><b>é¢¨åŠ›ç‹€æ…‹ï¼š</b> é¢¨é€Ÿ ${today.wind} km/h å±¬æ–¼è¼•ç´šï¼Œèƒ½ç¨å¾®å¸¶èµ°ç†±é‡ï¼Œä½†è‹¥æ¿•åº¦æ¥µé«˜ï¼Œæ•£ç†±æ•ˆæœæœ‰é™ã€‚</p>
                        <p><b>é˜²æ›¬å»ºè­°ï¼š</b> ç´«å¤–ç·šæŒ‡æ•¸ ${today.uv}ã€‚${today.uv > 6 ? 'å¼·çƒˆå»ºè­°ä½¿ç”¨é˜²æ›¬ä¹³æˆ–ç‰©ç†é®è”½ç‰©ã€‚' : 'ä¸­åº¦å¼·åº¦ï¼Œé•·æ™‚é–“å¾…åœ¨æˆ¶å¤–ä»éœ€é˜²è­·ã€‚'}</p>
                    </div>`;
            } else if (type === 'chart') {
                title.innerText = "åœ–è¡¨æ•¸æ“šè§£è®€";
                body.innerHTML = `æ­¤åœ–è¡¨æ¡ç”¨**å‹•æ…‹åº§æ¨™è»¸æŠ€è¡“**ï¼Œè‡ªå‹•åµæ¸¬ç•¶é€±æ°£æº«èµ·ä¼ï¼Œèª‡å¤§è¦–è¦ºå·®è·ï¼Œè®“æ‚¨æ›´ç›´è§€æ„Ÿå—æ—¥å¤œæº«å·®ã€‚èƒŒæ™¯è‰²å¡Šä»£è¡¨æ¯æ—¥æœ€å¤§é™é›¨æ©Ÿç‡ã€‚`;
            } else if (type === 'day') {
                const d = unifiedData[index + 1];
                title.innerText = `${d.displayDate} ç´°ç¯€`;
                body.innerHTML = `
                    æ¥µç«¯æ°£æº«ï¼š${d.high}Â°C / ${d.low}Â°C<br>
                    é™é›¨æ©Ÿç‡ï¼š${d.rainProb}%<br>
                    ç´«å¤–ç·šæŒ‡æ•¸ï¼š${d.uv}<br>
                    å¹³å‡æ¿•åº¦ï¼š${d.humid}%<br>
                    æœ€é«˜é¢¨é€Ÿï¼š${d.wind} km/h
                `;
            }
            modal.classList.add('active');
        }

        function closeModal() { document.getElementById('infoModal').classList.remove('active'); }
        document.getElementById('locationSelect').addEventListener('change', (e) => handleLocationChange(e.target.value));
        window.onload = () => handleLocationChange('gps');
    </script>
</body>
</html>

